<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Image to Scan PDF - Ver 1.15</title>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --border: #e2e8f0; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; display: flex; color: #1e293b; }
        .sidebar { width: 260px; background: white; border-right: 1px solid #e2e8f0; position: fixed; height: 100vh; }
        .main-content { flex: 1; margin-left: 260px; padding: 40px; }
        .container { max-width: 900px; margin: 0 auto; position: relative; }
        .version { position: absolute; top: 0; right: 0; font-size: 0.8rem; font-weight: bold; color: #64748b; background: #eee; padding: 2px 8px; border-radius: 4px; }
        
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; margin-bottom: 20px; }
        .control-group { display: flex; gap: 20px; margin-bottom: 20px; }
        .control-item { flex: 1; }
        select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; font-size: 1rem; margin-top: 5px; outline: none; }

        .drop-zone { border: 2px dashed #3b82f6; padding: 50px; text-align: center; border-radius: 12px; cursor: pointer; background: #f0f7ff; transition: 0.3s; }
        .drop-zone:hover { background: #e0efff; }
        
        #log { font-size: 0.95rem; color: #2563eb; font-weight: bold; margin: 15px 0; min-height: 1.2em; display: flex; align-items: center; gap: 8px; }

        .preview-area { display: none; }
        .canvas-container { background: #334155; padding: 20px; border-radius: 12px; display: flex; justify-content: center; margin-top: 10px; }
        canvas { max-width: 100%; height: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.3); background: white; }
        
        .btn-save { background: #059669; color: white; border: none; padding: 20px; border-radius: 10px; font-weight: bold; width: 100%; cursor: pointer; font-size: 1.2rem; margin-top: 25px; transition: 0.2s; }
        .btn-save:hover { background: #047857; transform: translateY(-2px); }
    </style>
</head>
<body>

<aside class="sidebar" id="common-sidebar"></aside>

<main class="main-content">
    <div class="container">
        <div class="version">Ver 1.15</div>
        <h2>ğŸš€ High-Quality Auto-Scanner</h2>

        <div class="card">
            <div class="control-group">
                <div class="control-item">
                    <label><strong>1. ç”¨ç´™ã‚µã‚¤ã‚º:</strong></label>
                    <select id="paper-size">
                        <option value="a4">A4</option>
                        <option value="a3">A3</option>
                        <option value="b4" selected>B4</option>
                    </select>
                </div>
                <div class="control-item">
                    <label><strong>2. ç”¨ç´™ã®å‘ã:</strong></label>
                    <select id="paper-orientation">
                        <option value="p">ç¸¦å‘ã (Portrait)</option>
                        <option value="l">æ¨ªå‘ã (Landscape)</option>
                    </select>
                </div>
            </div>

            <div class="drop-zone" id="drop-zone">
                <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“„</div>
                <strong>ç”»åƒã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—</strong>
                <p style="color: #64748b; font-size: 0.9rem;">AIãŒè‡ªå‹•ã§å‘ãã‚’è£œæ­£ã—ã€é«˜ç”»è³ªPDFåŒ–ã—ã¾ã™</p>
                <input type="file" id="file-input" accept="image/*" style="display:none;">
            </div>
            <div id="log"></div>
        </div>

        <div id="preview-area" class="card preview-area">
            <h3>3. é«˜è§£åƒåº¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆè‡ªå‹•å›è»¢æ¸ˆã¿ï¼‰</h3>
            <div class="canvas-container">
                <canvas id="main-canvas"></canvas>
            </div>
            <button class="btn-save" id="save-pdf">é«˜ç”»è³ªPDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        </div>
    </div>
</main>

<script>
    const paperMap = { a4: [210, 297], a3: [297, 420], b4: [250, 353] };
    let currentImg = null;
    let autoRotation = 0;

    fetch('sidebar.html').then(res => res.text()).then(data => {
        document.getElementById('common-sidebar').innerHTML = data;
    });

    const fileInput = document.getElementById('file-input');
    document.getElementById('drop-zone').onclick = () => fileInput.click();
    fileInput.onchange = (e) => startProcess(e.target.files[0]);

    function log(msg) { document.getElementById('log').innerText = msg; }

    async function startProcess(file) {
        if(!file) return;
        log("âŒ› ç”»åƒã‚’èª­ã¿è¾¼ã¿ä¸­...");
        
        currentImg = await new Promise(res => {
            const r = new FileReader();
            r.onload = e => { const i = new Image(); i.onload = () => res(i); i.src = e.target.result; };
            r.readAsDataURL(file);
        });

        log("ğŸ§  AIãŒæ–‡å­—ã®å‘ãã‚’è§£æã—ã¦è‡ªå‹•å›è»¢ä¸­...");
        const worker = await Tesseract.createWorker();
        await worker.loadLanguage('jpn+eng');
        await worker.initialize('jpn+eng');
        const { data } = await worker.detect(currentImg);
        await worker.terminate();
        
        autoRotation = data.orientation_degrees || 0;
        log(`âœ… è‡ªå‹•å›è»¢æˆåŠŸï¼ˆ${autoRotation}Â°ï¼‰ç”»è³ªã‚’æœ€é©åŒ–ã—ã¦ã„ã¾ã™...`);

        renderPreview();
    }

    function renderPreview() {
        if(!currentImg) return;

        const sizeKey = document.getElementById('paper-size').value;
        const orient = document.getElementById('paper-orientation').value;
        let [pW, pH] = paperMap[sizeKey];
        if (orient === 'l') [pW, pH] = [pH, pW];

        const canvas = document.getElementById('main-canvas');
        const ctx = canvas.getContext('2d', { alpha: false });

        // ã€æ”¹å–„ã€‘è§£åƒåº¦ã‚’å¤§å¹…ã‚¢ãƒƒãƒ— (300dpiä»¥ä¸Šã®å“è³ªã‚’ç›®æŒ‡ã™)
        const scaleFactor = 4.5; 
        canvas.width = pW * scaleFactor;
        canvas.height = pH * scaleFactor;

        // èƒŒæ™¯ã‚’ã‚¯ãƒªã‚¢ãªç™½ã«
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.save();
        ctx.translate(canvas.width / 2, canvas.height / 2);
        
        // AIãŒåˆ¤å®šã—ãŸå‘ãã«è‡ªå‹•å›è»¢
        ctx.rotate((-autoRotation * Math.PI) / 180);

        let drawW = currentImg.width;
        let drawH = currentImg.height;
        if (autoRotation % 180 !== 0) [drawW, drawH] = [drawH, drawW];

        // æ ã«åã‚ã‚‹è¨ˆç®—
        const fitScale = Math.min(canvas.width / drawW, canvas.height / drawH);
        
        // ç”»è³ªåŠ£åŒ–ã‚’é˜²ããŸã‚ã®ã‚¹ãƒ ãƒ¼ã‚ºæç”»è¨­å®š
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';

        // ã‚¹ã‚­ãƒ£ãƒ³è£œæ­£ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆé®®æ˜åŒ–ï¼‰
        ctx.filter = 'contrast(1.4) brightness(1.05) grayscale(0.2)';
        ctx.drawImage(currentImg, -currentImg.width * fitScale / 2, -currentImg.height * fitScale / 2, currentImg.width * fitScale, currentImg.height * fitScale);
        ctx.restore();

        document.getElementById('preview-area').style.display = 'block';
        log("âœ¨ å®Œäº†ã—ã¾ã—ãŸã€‚");
    }

    // è¨­å®šå¤‰æ›´æ™‚ã«è‡ªå‹•ã§æãç›´ã—
    document.getElementById('paper-size').onchange = renderPreview;
    document.getElementById('paper-orientation').onchange = renderPreview;

    document.getElementById('save-pdf').onclick = () => {
        const { jsPDF } = window.jspdf;
        const sizeKey = document.getElementById('paper-size').value;
        const orient = document.getElementById('paper-orientation').value;
        let [w, h] = paperMap[sizeKey];
        if (orient === 'l') [w, h] = [h, w];

        const canvas = document.getElementById('main-canvas');
        const pdf = new jsPDF(orient, 'mm', [w, h]);
        
        // ã€æ”¹å–„ã€‘JPEGã®å“è³ªã‚’æœ€é«˜ãƒ¬ãƒ™ãƒ«(1.0)ã«ã€FASTã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å¤–ã—ã¦é«˜å“è³ªæ›¸ãå‡ºã—
        const imgData = canvas.toDataURL('image/jpeg', 0.98);
        pdf.addImage(imgData, 'JPEG', 0, 0, w, h, undefined, 'SLOW');
        pdf.save(`HighRes_Scan_${sizeKey}.pdf`);
    };
</script>
</body>
</html>
