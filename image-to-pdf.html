<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Image to Scan PDF - Ver 1.17</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; display: flex; color: #1e293b; }
        .sidebar { width: 260px; background: white; border-right: 1px solid #e2e8f0; position: fixed; height: 100vh; }
        .main-content { flex: 1; margin-left: 260px; padding: 40px; }
        .container { max-width: 800px; margin: 0 auto; position: relative; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; margin-bottom: 20px; }
        .control-group { display: flex; gap: 20px; margin-bottom: 20px; }
        .control-item { flex: 1; }
        select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; font-size: 1rem; margin-top: 5px; }
        
        /* ã‚¯ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ã®èª¿æ•´ */
        .crop-container { width: 100%; max-height: 500px; background: #333; border-radius: 8px; overflow: hidden; display: none; margin-top: 20px; }
        img { max-width: 100%; }

        .drop-zone { border: 2px dashed #3b82f6; padding: 40px; text-align: center; border-radius: 12px; cursor: pointer; background: #f0f7ff; }
        .btn-save { background: #059669; color: white; border: none; padding: 20px; border-radius: 10px; font-weight: bold; width: 100%; cursor: pointer; font-size: 1.2rem; margin-top: 25px; display: none; }
        #log { font-size: 0.95rem; color: #2563eb; font-weight: bold; margin: 15px 0; }
        .hint { font-size: 0.85rem; color: #64748b; margin-bottom: 10px; }
    </style>
</head>
<body>

<aside class="sidebar" id="common-sidebar"></aside>

<main class="main-content">
    <div class="container">
        <div class="version" style="text-align:right; font-size:0.8rem; color:#64748b;">Ver 1.17</div>
        <h2>ğŸ–¼ï¸ Scan PDF Cropper</h2>

        <div class="card">
            <div class="control-group">
                <div class="control-item">
                    <label>ç”¨ç´™ã‚µã‚¤ã‚º:</label>
                    <select id="paper-size">
                        <option value="a4">A4</option>
                        <option value="a3">A3</option>
                        <option value="b4" selected>B4</option>
                    </select>
                </div>
                <div class="control-item">
                    <label>ç”¨ç´™ã®å‘ã:</label>
                    <select id="paper-orientation">
                        <option value="p">ç¸¦å‘ã (Portrait)</option>
                        <option value="l">æ¨ªå‘ã (Landscape)</option>
                    </select>
                </div>
            </div>

            <div class="drop-zone" id="drop-zone">
                <div style="font-size: 40px;">ğŸ“¸</div>
                <strong>ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</strong>
            </div>
            <input type="file" id="file-input" accept="image/*" style="display:none;">
            <div id="log"></div>
        </div>

        <div id="edit-area" class="card" style="display:none;">
            <h3>æ›¸é¡ã®ç¯„å›²ã‚’é¸æŠ</h3>
            <p class="hint">æ ã®è§’ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ã€æ›¸é¡ã®ç«¯ã«åˆã‚ã›ã¦ãã ã•ã„ï¼ˆä½™ç™½ã‚’ã‚«ãƒƒãƒˆã—ã¾ã™ï¼‰</p>
            <div class="crop-container">
                <img id="image-to-crop">
            </div>
            <button class="btn-save" id="generate-pdf">é¸æŠã—ãŸç¯„å›²ã‚’B4 PDFã«ã™ã‚‹</button>
        </div>
    </div>
</main>

<script>
    let cropper = null;
    const paperMap = { a4: [210, 297], a3: [297, 420], b4: [250, 353] };

    fetch('sidebar.html').then(res => res.text()).then(data => {
        document.getElementById('common-sidebar').innerHTML = data;
    });

    const fileInput = document.getElementById('file-input');
    const dropZone = document.getElementById('drop-zone');
    const imgEl = document.getElementById('image-to-crop');

    dropZone.onclick = () => fileInput.click();
    fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                if (cropper) cropper.destroy();
                imgEl.src = event.target.result;
                document.getElementById('edit-area').style.display = 'block';
                document.querySelector('.crop-container').style.display = 'block';
                document.getElementById('generate-pdf').style.display = 'block';
                
                // CropperåˆæœŸåŒ–
                cropper = new Cropper(imgEl, {
                    autoCropArea: 0.8, // æœ€åˆã¯å°‘ã—ä½™è£•ã‚’æŒã£ã¦å›²ã‚€
                    movable: true,
                    zoomable: true,
                    rotatable: true,
                });
            };
            reader.readAsDataURL(file);
        }
    };

    document.getElementById('generate-pdf').onclick = () => {
        if (!cropper) return;

        const sizeKey = document.getElementById('paper-size').value;
        const orient = document.getElementById('paper-orientation').value;
        let [pW, pH] = paperMap[sizeKey];
        if (orient === 'l') [pW, pH] = [pH, pW];

        // é«˜ç”»è³ªã§åˆ‡ã‚ŠæŠœãç”»åƒã‚’å–å¾—
        const canvas = cropper.getCroppedCanvas({
            width: pW * 4, // B4ãªã‚‰ç´„3000pxä»¥ä¸Šã®é«˜è§£åƒåº¦
            fillColor: '#fff',
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high',
        });

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF(orient, 'mm', [pW, pH]);
        
        // åˆ‡ã‚ŠæŠœã„ãŸéƒ¨åˆ†ã ã‘ã‚’ç”¨ç´™ã„ã£ã±ã„ã«é…ç½®
        const imgData = canvas.toDataURL('image/jpeg', 0.95);
        pdf.addImage(imgData, 'JPEG', 0, 0, pW, pH);
        pdf.save(`Scan_Fixed_Size.pdf`);
        
        document.getElementById('log').innerText = "âœ… PDFã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚";
    };
</script>
</body>
</html>
