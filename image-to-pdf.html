<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image to Scan PDF - Version 1.04 (Auto Rotate)</title>
    <script async src="https://docs.opencv.org/4.5.4/opencv.js" onload="onOpenCvReady();"></script>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root { --primary: #2563eb; --bg-color: #f8fafc; --border: #e2e8f0; }
        body { font-family: sans-serif; background: var(--bg-color); margin: 0; display: flex; }
        .sidebar { width: 260px; background: white; border-right: 1px solid var(--border); position: fixed; height: 100vh; z-index: 100; }
        .main-content { flex: 1; margin-left: 260px; padding: 40px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 900px; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid var(--border); }
        .drop-zone { border: 2px dashed var(--border); padding: 40px; text-align: center; border-radius: 15px; cursor: pointer; background: #fafafa; }
        #preview-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; margin-top: 20px; }
        .preview-box { position: relative; background: #fff; border: 1px solid var(--border); border-radius: 12px; padding: 10px; }
        .img-wrap { width: 100%; aspect-ratio: 1/1.4; display: flex; align-items: center; justify-content: center; overflow: hidden; background: #f1f5f9; border-radius: 8px; }
        .img-wrap img { max-width: 100%; max-height: 100%; }
        .status-badge { font-size: 0.7rem; background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 10px; margin-bottom: 5px; display: inline-block; }
        .btn { background: var(--primary); color: white; border: none; padding: 18px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; font-size: 1.1rem; }
        #status-display { margin: 10px 0; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

<aside class="sidebar" id="common-sidebar"></aside>

<main class="main-content">
    <div class="container">
        <header>
            <span style="background:#e2e8f0; padding:4px 12px; border-radius:20px; font-size:0.8rem;">Version 1.04</span>
            <h1>ğŸ–¼ï¸ Auto-Scan to PDF</h1>
            <p id="status-display">ã‚¨ãƒ³ã‚¸ãƒ³èª­ã¿è¾¼ã¿ä¸­...</p>
        </header>

        <div class="card">
            <label><strong>1. ç”¨ç´™ã‚µã‚¤ã‚º:</strong></label>
            <select id="paper-size" style="width:100%; padding:10px; margin: 10px 0 20px 0; border-radius:8px;">
                <option value="a4">A4</option><option value="a3">A3</option><option value="b4">B4</option>
            </select>
            <div class="drop-zone" id="drop-zone">ğŸ“¥ ç”»åƒã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦è‡ªå‹•å‘ãè£œæ­£</div>
            <input type="file" id="file-input" multiple accept="image/*" style="display:none;">
        </div>

        <div id="processing-area" class="card" style="display:none;">
            <h3>å¤‰æ›ã‚­ãƒ¥ãƒ¼ï¼ˆè‡ªå‹•å‘ãè£œæ­£ãƒ»ã‚¹ã‚­ãƒ£ãƒ³æ¸ˆï¼‰</h3>
            <div id="preview-container"></div>
            <button class="btn" id="generate-btn" style="margin-top:25px;">PDFã‚’ä¿å­˜</button>
        </div>
    </div>
</main>

<script>
    let imagesData = [];
    const { jsPDF } = window.jspdf;

    function onOpenCvReady() { document.getElementById('status-display').innerText = "âœ… æº–å‚™å®Œäº†"; }

    fetch('sidebar.html').then(res => res.text()).then(data => {
        document.getElementById('common-sidebar').innerHTML = data;
    });

    const fileInput = document.getElementById('file-input');
    const dropZone = document.getElementById('drop-zone');

    dropZone.onclick = () => fileInput.click();
    fileInput.onchange = (e) => handleFiles(e.target.files);
    dropZone.ondragover = (e) => e.preventDefault();
    dropZone.ondrop = (e) => { e.preventDefault(); handleFiles(e.dataTransfer.files); };

    async function handleFiles(files) {
        if (!files.length) return;
        document.getElementById('processing-area').style.display = 'block';
        const status = document.getElementById('status-display');

        for (let file of files) {
            status.innerText = `è§£æä¸­: ${file.name}...`;
            const imgElement = await loadImage(file);
            
            // 1. æ–‡å­—ã®å‘ãã‚’è‡ªå‹•åˆ¤å®š (OCR)
            const orientation = await detectOrientation(imgElement);
            
            // 2. å›è»¢ã•ã›ã¦ã‹ã‚‰ã‚¹ã‚­ãƒ£ãƒ³è£œæ­£
            const rotatedCanvas = await rotateAndProcess(imgElement, orientation);
            const dataUrl = rotatedCanvas.toDataURL('image/jpeg', 0.85);
            
            imagesData.push(dataUrl);
            addPreview(dataUrl, orientation);
        }
        status.innerText = "âœ… å…¨ã¦ã®ç”»åƒã®å‘ãã‚’è£œæ­£ã—ã¾ã—ãŸã€‚";
    }

    function loadImage(file) {
        return new Promise(res => {
            const r = new FileReader();
            r.onload = e => { const i = new Image(); i.onload = () => res(i); i.src = e.target.result; };
            r.readAsDataURL(file);
        });
    }

    // --- OCRã«ã‚ˆã‚‹å‘ãåˆ¤å®š ---
    async function detectOrientation(img) {
        // Tesseract.jsã®å‘ãæ¤œå‡ºæ©Ÿèƒ½ã‚’åˆ©ç”¨
        const worker = await Tesseract.createWorker();
        await worker.loadLanguage('jpn+eng');
        await worker.initialize('jpn+eng');
        const { data } = await worker.detect(img);
        await worker.terminate();
        
        // orientation_degrees: 0, 90, 180, 270
        return data.orientation_degrees || 0;
    }

    // --- å›è»¢ & ã‚¹ã‚­ãƒ£ãƒ³é¢¨å‡¦ç† ---
    async function rotateAndProcess(img, degrees) {
        let src = cv.imread(img);
        let dst = new cv.Mat();
        
        // å‘ãè£œæ­£ (degreesåˆ†ã ã‘ã€Œé€†è»¢ã€ã•ã›ã‚‹)
        if (degrees !== 0) {
            let center = new cv.Point(src.cols / 2, src.rows / 2);
            let M = cv.getRotationMatrix2D(center, -degrees, 1); // é€†å›è»¢
            // å›è»¢å¾Œã®ã‚µã‚¤ã‚ºè¨ˆç®—
            let newSize = (degrees === 90 || degrees === 270) ? 
                          new cv.Size(src.rows, src.cols) : new cv.Size(src.cols, src.rows);
            cv.warpAffine(src, dst, M, newSize, cv.INTER_LINEAR, cv.BORDER_CONSTANT, new cv.Scalar());
        } else {
            src.copyTo(dst);
        }

        // ã‚¹ã‚­ãƒ£ãƒ³é¢¨è£œæ­£
        cv.cvtColor(dst, dst, cv.COLOR_RGBA2GRAY);
        cv.adaptiveThreshold(dst, dst, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 21, 10);
        
        let blurred = new cv.Mat();
        cv.GaussianBlur(dst, blurred, new cv.Size(0,0), 2);
        cv.addWeighted(dst, 1.5, blurred, -0.5, 0, dst);

        const canvas = document.createElement('canvas');
        cv.imshow(canvas, dst);
        src.delete(); dst.delete(); blurred.delete();
        return canvas;
    }

    function addPreview(url, deg) {
        const container = document.getElementById('preview-container');
        const box = document.createElement('div');
        box.className = 'preview-box';
        box.innerHTML = `
            <span class="status-badge">è£œæ­£: ${deg}Â°</span>
            <div class="img-wrap"><img src="${url}"></div>
        `;
        container.appendChild(box);
    }

    document.getElementById('generate-btn').onclick = function() {
        const format = document.getElementById('paper-size').value;
        const pdf = new jsPDF('p', 'mm', format);
        const w = pdf.internal.pageSize.getWidth();
        const h = pdf.internal.pageSize.getHeight();

        imagesData.forEach((data, i) => {
            if (i > 0) pdf.addPage();
            pdf.addImage(data, 'JPEG', 0, 0, w, h);
        });
        pdf.save("auto_scanned.pdf");
    };
</script>
</body>
</html>
