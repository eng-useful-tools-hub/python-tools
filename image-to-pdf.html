<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Image to Scan PDF - Ver 1.08</title>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        // OpenCVã®èª­ã¿è¾¼ã¿å®Œäº†ã‚’ç¢ºå®Ÿã«æ¤œçŸ¥
        var cvReady = false;
        function onOpenCvReady() {
            cvReady = true;
            const badge = document.getElementById('engine-status');
            const zone = document.getElementById('drop-zone');
            if (badge) {
                badge.innerText = "âœ… ã‚¨ãƒ³ã‚¸ãƒ³æº–å‚™å®Œäº†ï¼ç”»åƒã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„";
                badge.style.background = "#dcfce7";
                badge.style.color = "#166534";
            }
            if (zone) zone.style.opacity = "1";
        }
    </script>
    <script async src="https://docs.opencv.org/4.5.4/opencv.js" onload="onOpenCvReady();"></script>

    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --border: #e2e8f0; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; display: flex; color: #1e293b; }
        .sidebar { width: 260px; background: white; border-right: 1px solid var(--border); position: fixed; height: 100vh; }
        .main-content { flex: 1; margin-left: 260px; padding: 40px; }
        .container { max-width: 800px; margin: 0 auto; position: relative; }
        .version { position: absolute; top: 0; right: 0; font-size: 0.8rem; font-weight: bold; color: #64748b; }
        .engine-badge { padding: 10px; border-radius: 8px; background: #fee2e2; color: #991b1b; font-size: 0.9rem; font-weight: bold; margin-bottom: 20px; text-align: center; border: 1px solid #fecaca; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); border: 1px solid var(--border); }
        .drop-zone { border: 2px dashed #cbd5e1; padding: 50px; text-align: center; border-radius: 12px; cursor: pointer; opacity: 0.4; transition: 0.3s; background: #fcfcfc; }
        .btn { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 10px; font-weight: bold; width: 100%; cursor: pointer; margin-top: 20px; }
        #log { font-size: 0.8rem; color: #64748b; margin-top: 15px; font-family: monospace; max-height: 100px; overflow-y: auto; }
        .preview-box { display: none; margin-top: 25px; border-top: 2px solid var(--border); padding-top: 20px; }
        .img-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .img-grid img { width: 100%; border-radius: 8px; border: 1px solid var(--border); background: #eee; }
    </style>
</head>
<body>

<aside class="sidebar" id="common-sidebar"></aside>

<main class="main-content">
    <div class="container">
        <div class="version">Ver 1.08</div>
        <h2>ğŸ–¼ï¸ Scan PDF Converter</h2>
        <div id="engine-status" class="engine-badge">â³ å‡¦ç†ã‚¨ãƒ³ã‚¸ãƒ³ã‚’èª­ã¿è¾¼ã¿ä¸­...ï¼ˆå°‘ã—ãŠå¾…ã¡ãã ã•ã„ï¼‰</div>

        <div class="card">
            <label>å‡ºåŠ›ã‚µã‚¤ã‚º:</label>
            <select id="paper-size" style="width:100%; padding:10px; margin: 10px 0 20px 0; border-radius:8px;">
                <option value="a4">A4 (210x297mm)</option>
                <option value="a3">A3 (297x420mm)</option>
            </select>

            <div class="drop-zone" id="drop-zone">
                <div style="font-size: 40px;">ğŸ“‚</div>
                ã“ã“ã«ç”»åƒã‚’ãƒ‰ãƒ­ãƒƒãƒ—
                <input type="file" id="file-input" accept="image/*" style="display:none;">
            </div>
            <div id="log"></div>
        </div>

        <div id="preview-area" class="preview-box card">
            <div class="img-grid">
                <div><p>å…ƒç”»åƒ</p><img id="view-orig"></div>
                <div><p>è£œæ­£å¾Œ</p><img id="view-proc"></div>
            </div>
            <button class="btn" id="save-pdf">PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        </div>
    </div>
</main>

<script>
    let finalImg = null;
    function log(m) { document.getElementById('log').innerHTML += `> ${m}<br>`; }

    // ã‚µã‚¤ãƒ‰ãƒãƒ¼èª­ã¿è¾¼ã¿
    fetch('sidebar.html').then(res => res.text()).then(data => {
        document.getElementById('common-sidebar').innerHTML = data;
    });

    const zone = document.getElementById('drop-zone');
    zone.onclick = () => { if(cvReady) document.getElementById('file-input').click(); };
    document.getElementById('file-input').onchange = (e) => start(e.target.files[0]);
    zone.ondragover = (e) => e.preventDefault();
    zone.ondrop = (e) => { e.preventDefault(); if(cvReady) start(e.dataTransfer.files[0]); };

    async function start(file) {
        if(!file) return;
        document.getElementById('log').innerHTML = "";
        log("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...");
        
        const img = await new Promise(res => {
            const r = new FileReader();
            r.onload = e => { const i = new Image(); i.onload = () => res(i); i.src = e.target.result; };
            r.readAsDataURL(file);
        });
        document.getElementById('view-orig').src = img.src;

        log("OCRã§å‘ãã‚’åˆ¤å®šä¸­...");
        const worker = await Tesseract.createWorker();
        await worker.loadLanguage('jpn+eng');
        await worker.initialize('jpn+eng');
        const { data } = await worker.detect(img);
        await worker.terminate();
        
        const deg = data.orientation_degrees || 0;
        log(`å‘ãã‚’ ${deg}åº¦ è£œæ­£ã—ã€ã‚¹ã‚­ãƒ£ãƒ³é¢¨ã«åŠ å·¥ä¸­...`);

        // ç”»åƒå‡¦ç†
        let src = cv.imread(img);
        let dst = new cv.Mat();
        if (deg !== 0) {
            let center = new cv.Point(src.cols / 2, src.rows / 2);
            let M = cv.getRotationMatrix2D(center, -deg, 1);
            let newSize = (deg === 90 || deg === 270) ? new cv.Size(src.rows, src.cols) : new cv.Size(src.cols, src.rows);
            if(deg === 90 || deg === 270) {
                M.data64F[2] += (newSize.width - src.cols) / 2;
                M.data64F[5] += (newSize.height - src.rows) / 2;
            }
            cv.warpAffine(src, dst, M, newSize, cv.INTER_LINEAR, cv.BORDER_CONSTANT, new cv.Scalar(255,255,255,255));
        } else {
            src.copyTo(dst);
        }
        cv.cvtColor(dst, dst, cv.COLOR_RGBA2GRAY);
        cv.adaptiveThreshold(dst, dst, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 21, 15);
        
        const canvas = document.createElement('canvas');
        cv.imshow(canvas, dst);
        finalImg = canvas.toDataURL('image/jpeg', 0.9);
        
        document.getElementById('view-proc').src = finalImg;
        document.getElementById('preview-area').style.display = 'block';
        src.delete(); dst.delete();
        log("æº–å‚™å®Œäº†ï¼");
    }

    document.getElementById('save-pdf').onclick = () => {
        const { jsPDF } = window.jspdf;
        const size = document.getElementById('paper-size').value;
        const pdf = new jsPDF('p', 'mm', size);
        pdf.addImage(finalImg, 'JPEG', 0, 0, pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight());
        pdf.save("scan_document.pdf");
    };
</script>
</body>
</html>
