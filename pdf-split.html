<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>PDFåˆ†å‰²ãƒ—ãƒ­ï¼šãƒšãƒ¼ã‚¸ãƒ»å®¹é‡åˆ‡æ›¿ãƒ¢ãƒ‡ãƒ«</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2023.11.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2023.11.1/core.js"></script>
    <py-config>
        packages = ["pypdf"]
    </py-config>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; padding: 20px; max-width: 700px; margin: auto; background-color: #f0f2f5; color: #1c1e21; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; border: 1px solid #ddd; }
        h1 { color: #0969da; text-align: center; }
        #drop_zone { border: 3px dashed #0969da; border-radius: 12px; padding: 40px; text-align: center; background-color: #f8fbff; cursor: pointer; transition: 0.3s; margin-bottom: 15px; }
        #drop_zone:hover { background-color: #ebf5ff; }
        .mode-switch { display: flex; gap: 10px; margin-bottom: 20px; background: #eee; padding: 5px; border-radius: 8px; }
        .mode-switch label { flex: 1; text-align: center; padding: 10px; cursor: pointer; border-radius: 6px; font-weight: bold; }
        .mode-switch input { display: none; }
        .mode-switch input:checked + span { background: #0969da; color: white; display: block; border-radius: 6px; padding: 10px; margin: -10px; }
        button { background-color: #0969da; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; padding: 15px; font-size: 16px; transition: 0.2s; }
        button:hover { background-color: #0550ae; }
        #download_link { display: none; text-align: center; background-color: #2ea44f; color: white; padding: 15px; text-decoration: none; border-radius: 8px; font-weight: bold; margin-top: 15px; }
        #status { color: #d1242f; font-weight: bold; text-align: center; margin-top: 10px; }
        .info-badge { background: #e7f3ff; color: #0969da; padding: 2px 8px; border-radius: 4px; font-size: 0.9em; }
    </style>
</head>
<body>
    <h1>âœ‚ï¸ PDFåˆ†å‰²ãƒ—ãƒ­</h1>
    
    <div class="card">
        <div id="drop_zone">ğŸ“‚ ã“ã“ã«PDFã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã€ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯</div>
        <input type="file" id="file_input" accept="application/pdf" style="display: none;" py-change="on_file_loaded">
        <div id="file_info"></div>
        <div id="status"></div>
    </div>

    <div id="step2_area" class="card" style="display: none;">
        <h3>Step 2: åˆ†å‰²æ–¹æ³•ã‚’é¸æŠ</h3>
        
        <div class="mode-switch">
            <label><input type="radio" name="mode" value="page" checked py-change="update_ui"><span>ğŸ“„ ãƒšãƒ¼ã‚¸æ•°ã§åˆ†å‰²</span></label>
            <label><input type="radio" name="mode" value="size" py-change="update_ui"><span>âš–ï¸ å®¹é‡(MB)ã§åˆ†å‰²</span></label>
        </div>

        <div id="setting_input_area" style="margin-bottom: 20px;">
            </div>

        <div id="preview_area" style="background: #f9f9f9; padding: 15px; border-radius: 8px; font-size: 0.9em; border: 1px solid #eee;">
        </div>

        <button id="split_btn" style="margin-top:20px;" py-click="execute_split">å®Ÿè¡Œã—ã¦ZIPã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        <a id="download_link">â¬‡ï¸ æº–å‚™å®Œäº†ï¼ZIPã‚’ä¿å­˜</a>
    </div>

    <script>
        const dropZone = document.getElementById('drop_zone');
        const fileInput = document.getElementById('file_input');
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            if (e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files;
                fileInput.dispatchEvent(new Event('change', { bubbles: true }));
            }
        });
    </script>

    <script type="py">
        import io, math, zipfile
        from js import document, Uint8Array, Blob, URL
        from pypdf import PdfReader, PdfWriter

        pdf_bytes = None
        total_pages = 0
        file_name = ""
        original_size_mb = 0

        async def on_file_loaded(event):
            global pdf_bytes, total_pages, file_name, original_size_mb
            file = document.getElementById("file_input").files.item(0)
            if not file: return
            file_name = file.name
            original_size_mb = file.size / (1024 * 1024)
            
            array_buffer = await file.arrayBuffer()
            pdf_bytes = bytes(Uint8Array.new(array_buffer))
            reader = PdfReader(io.BytesIO(pdf_bytes))
            total_pages = len(reader.pages)
            
            document.getElementById("file_info").innerHTML = f"<b>{file_name}</b> <span class='info-badge'>{total_pages}ãƒšãƒ¼ã‚¸</span> <span class='info-badge'>{original_size_mb:.2f} MB</span>"
            document.getElementById("step2_area").style.display = "block"
            update_ui(None)

        def update_ui(event):
            mode = document.querySelector('input[name="mode"]:checked').value
            area = document.getElementById("setting_input_area")
            preview = document.getElementById("preview_area")
            
            if mode == "page":
                area.innerHTML = f'åˆ†å‰²ã™ã‚‹æ•°: <input type="number" id="val_input" value="2" min="2" max="{total_pages}" style="width:60px; padding:5px;" py-change="refresh_preview"> åˆ†å‰²'
            else:
                default_size = math.ceil(original_size_mb / 2 * 10) / 10
                area.innerHTML = f'1ãƒ•ã‚¡ã‚¤ãƒ«ã‚ãŸã‚Šã®ä¸Šé™: <input type="number" id="val_input" value="{default_size}" step="0.1" min="0.1" style="width:60px; padding:5px;" py-change="refresh_preview"> MB'
            
            refresh_preview(None)

        def refresh_preview(event):
            mode = document.querySelector('input[name="mode"]:checked').value
            val = float(document.getElementById("val_input").value or 0)
            preview = document.getElementById("preview_area")
            
            if val <= 0: return

            if mode == "page":
                step = total_pages / val
                lines = [f"ãƒ»1æšç›®: 1ï½{math.floor(step)}ãƒšãƒ¼ã‚¸"]
                for i in range(1, int(val)):
                    start = math.floor(step * i) + 1
                    end = math.floor(step * (i+1)) if i < val-1 else total_pages
                    lines.append(f"ãƒ»{i+1}æšç›®: {start}ï½{end}ãƒšãƒ¼ã‚¸")
                preview.innerHTML = "<b>äºˆæ¸¬ã•ã‚Œã‚‹åˆ†å‰²æ§‹æˆ:</b><br>" + "<br>".join(lines)
            else:
                # å®¹é‡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ¦‚ç®—ï¼‰
                estimated_files = math.ceil(original_size_mb / val)
                avg_pages = max(1, math.floor(total_pages / estimated_files))
                preview.innerHTML = f"<b>äºˆæ¸¬:</b> ç´„ {estimated_files} å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ†å‰²ã•ã‚Œã¾ã™ã€‚<br><small>â€»PDFã®å¯†åº¦ã«ã‚ˆã‚Šå‰å¾Œã—ã¾ã™</small>"

        async def execute_split(event):
            status = document.getElementById("status")
            status.innerText = "å‡¦ç†ä¸­..."
            try:
                mode = document.querySelector('input[name="mode"]:checked').value
                val = float(document.getElementById("val_input").value)
                reader = PdfReader(io.BytesIO(pdf_bytes))
                zip_buffer = io.BytesIO()
                
                with zipfile.ZipFile(zip_buffer, "a", zipfile.ZIP_DEFLATED) as zf:
                    if mode == "page":
                        # ãƒšãƒ¼ã‚¸æ•°ãƒ™ãƒ¼ã‚¹ã®åˆ†å‰²
                        step = total_pages / val
                        start = 0
                        for i in range(int(val)):
                            end = math.floor(step * (i+1)) if i < val-1 else total_pages
                            save_to_zip(zf, reader, start, end, i+1)
                            start = end
                    else:
                        # å®¹é‡ãƒ™ãƒ¼ã‚¹ã®åˆ†å‰²ï¼ˆé«˜åº¦ãªåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ï¼‰
                        start = 0
                        current_file_idx = 1
                        # 1ãƒšãƒ¼ã‚¸ã‚ãŸã‚Šã®æ¦‚ç®—ã‚µã‚¤ã‚º
                        page_size_avg = original_size_mb / total_pages
                        
                        current_writer = PdfWriter()
                        temp_pages = 0
                        
                        for p in range(total_pages):
                            current_writer.add_page(reader.pages[p])
                            temp_pages += 1
                            # æ¦‚ç®—ã‚µã‚¤ã‚ºãŒä¸Šé™ã‚’è¶…ãˆãã†ãªã‚‰ã€ã¾ãŸã¯æœ€å¾Œã®ãƒšãƒ¼ã‚¸ãªã‚‰
                            if (temp_pages * page_size_avg >= val and temp_pages > 1) or (p == total_pages - 1):
                                save_to_zip(zf, reader, start, p + 1, current_file_idx)
                                start = p + 1
                                current_file_idx += 1
                                temp_pages = 0
                
                # ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æº–å‚™
                blob = Blob.new([Uint8Array.new(zip_buffer.getvalue())], type="application/zip")
                link = document.getElementById("download_link")
                link.href = URL.createObjectURL(blob)
                link.download = f"split_{file_name.replace('.pdf', '')}.zip"
                link.style.display = "block"
                status.innerText = "âœ… å®Œäº†ï¼"
            except Exception as e:
                status.innerText = f"ã‚¨ãƒ©ãƒ¼: {e}"

        def save_to_zip(zf, reader, start, end, idx):
            writer = PdfWriter()
            for p in range(start, end):
                writer.add_page(reader.pages[p])
            out = io.BytesIO()
            writer.write(out)
            zf.writestr(f"part_{idx}_{start+1}-{end}page.pdf", out.getvalue())
    </script>
</body>
</html>
