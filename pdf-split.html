<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>PDFåˆ†å‰²ãƒ„ãƒ¼ãƒ« v1.17</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; max-width: 750px; margin: auto; line-height: 1.6; color: #333; background-color: #f0f2f5; }
        h1 { color: #1a73e8; border-bottom: 2px solid #1a73e8; padding-bottom: 10px; margin-bottom: 5px; }
        .version-tag { text-align: right; font-size: 0.8em; color: #777; margin-bottom: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px;}
        
        /* æ³¨æ„æ›¸ããƒ»å…è²¬äº‹é … */
        .notice-box { background-color: #fff4e5; border-left: 5px solid #ffa117; padding: 15px; margin-bottom: 20px; font-size: 0.85em; }
        .disclaimer { font-size: 0.8em; color: #666; margin-top: 30px; padding: 20px; border-top: 1px solid #ddd; line-height: 1.8; }

        #drop_zone { border: 2px dashed #1a73e8; border-radius: 10px; padding: 40px 20px; text-align: center; background: #fff; cursor: pointer; transition: 0.2s; }
        #drop_zone:hover { background: #f1f3f4; }
        
        .mode-selector { display: flex; gap: 10px; margin-bottom: 20px; }
        .mode-btn { flex: 1; padding: 12px; border: 2px solid #dadce0; border-radius: 8px; cursor: pointer; background: white; font-weight: bold; transition: 0.2s; }
        .mode-btn.active { border-color: #1a73e8; background: #e8f0fe; color: #1a73e8; }

        #status { font-weight: bold; margin: 15px 0; text-align: center; }
        .error { color: #d93025; }
        .warning { color: #e67e22; }
        .success { color: #1e8e3e; }

        button#split_btn { background-color: #1a73e8; color: white; border: none; border-radius: 6px; cursor: pointer; width: 100%; padding: 15px; font-size: 16px; font-weight: bold; }
        button#split_btn:disabled { background-color: #dadce0; }

        .progress-bar { width: 100%; background: #eee; height: 15px; border-radius: 8px; overflow: hidden; display: none; margin-top: 15px; border: 1px solid #ddd; }
        .progress-fill { width: 0%; background: #1a73e8; height: 100%; transition: width 0.1s; display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; }

        .input-group { margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; }
        input[type="number"] { width: 75px; padding: 8px; border: 1px solid #dadce0; border-radius: 4px; }
        .split-point-item { margin: 8px 0; display: flex; align-items: center; gap: 10px; font-size: 0.9em; }
    </style>
</head>
<body>

    <h1>âœ‚ï¸ PDFåˆ†å‰²ãƒ„ãƒ¼ãƒ«</h1>
    <div class="version-tag">Version 1.17 (High Capacity Trial Edition)</div>

    <div class="notice-box">
        <strong>ã€ã”åˆ©ç”¨ã®ç›®å®‰ã€‘</strong><br>
        ãƒ»ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ¡ãƒ¢ãƒªåˆ¶é™ã«ã‚ˆã‚Šã€æ¨å¥¨ã‚µã‚¤ã‚ºã¯<b>200MBã¾ã§</b>ã¨ãªã‚Šã¾ã™ã€‚<br>
        ãƒ»200MBã‚’è¶…ãˆã‚‹å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ã€Œãƒˆãƒ©ã‚¤ã€å¯èƒ½ã§ã™ãŒã€é€”ä¸­ã§ãƒ–ãƒ©ã‚¦ã‚¶ãŒç•°å¸¸çµ‚äº†ã—ãŸã‚Šã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ãã®éš›ã¯PCã®å†èµ·å‹•ã‚„ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¿ãƒ–ã‚’é–‰ã˜ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚
    </div>

    <div class="card">
        <h3>1. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€</h3>
        <div id="drop_zone">ğŸ“‚ PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ— ã¾ãŸã¯ ã‚¯ãƒªãƒƒã‚¯</div>
        <input type="file" id="file_input" accept="application/pdf" style="display: none;">
        <div id="file_info" style="margin-top:15px; font-weight:bold; color: #1a73e8;"></div>
        <div id="status"></div>
        <div class="progress-bar" id="p_bar"><div class="progress-fill" id="p_fill">0%</div></div>
    </div>

    <div id="step2_area" class="card" style="display: none;">
        <h3>2. åˆ†å‰²æ–¹æ³•ã®é¸æŠãƒ»èª¿æ•´</h3>
        
        <div class="mode-selector">
            <button class="mode-btn active" id="mode_page">ãƒšãƒ¼ã‚¸æŒ‡å®šã§åˆ†å‰²</button>
            <button class="mode-btn" id="mode_size">å®¹é‡(MB)ã§åˆ†å‰²</button>
        </div>

        <div id="page_setting" class="input-group">
            åˆ†å‰²å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«æ•°: <input type="number" id="num_splits" value="2" min="2" max="100"> å€‹
            <div id="split_points_container" style="margin-top:15px; padding-top:10px; border-top: 1px solid #eee;"></div>
        </div>

        <div id="size_setting" class="input-group" style="display: none;">
            1ãƒ•ã‚¡ã‚¤ãƒ«ã‚ãŸã‚Šã®ä¸Šé™ã‚µã‚¤ã‚º: <input type="number" id="size_limit" value="20" min="1"> MB
        </div>
        
        <button id="split_btn">åˆ†å‰²å‡¦ç†ã‚’é–‹å§‹ã™ã‚‹</button>
        <p id="finish_msg" style="display:none; text-align:center; color:#1e8e3e; font-weight:bold; margin-top:10px;">
            å…¨ã¦ã®åˆ†å‰²ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚
        </p>
    </div>

    <div class="disclaimer">
        <strong>ã€æœ¬ã‚µã‚¤ãƒˆã«ã¤ã„ã¦ã€‘</strong><br>
        ãƒ»æœ¬ãƒ„ãƒ¼ãƒ«ã¯å€‹äººã®å­¦ç¿’ãƒ»åˆ©ä¾¿æ€§å‘ä¸Šã®ãŸã‚ã«ä½œæˆã•ã‚ŒãŸã‚‚ã®ã§ã™ã€‚å‡¦ç†ã¯ã™ã¹ã¦ã”åˆ©ç”¨ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§è¡Œã‚ã‚Œã€ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>
        ãƒ»å‹•ä½œã«ã¯ä¸‡å…¨ã‚’æœŸã—ã¦ãŠã‚Šã¾ã™ãŒã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ¡ãƒ¢ãƒªçŠ¶æ³ã‚„PDFã®æ§‹é€ ã«ã‚ˆã‚Šã€äºˆæœŸã›ã¬ä¸å…·åˆã‚„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å ´åˆãŒã”ã–ã„ã¾ã™ã€‚æœ¬ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ãŸã“ã¨ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿ã®æå¤±ã‚„ãƒˆãƒ©ãƒ–ãƒ«ç­‰ã«ã¤ã„ã¦ã€è£½ä½œè€…ã¯ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã‹ã­ã¾ã™ã®ã§ã‚ã‚‰ã‹ã˜ã‚ã”äº†æ‰¿ãã ã•ã„ã€‚<br>
        ãƒ»å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†ã«å¤±æ•—ã™ã‚‹å ´åˆã¯ã€PDFã‚’ã‚ã‚‰ã‹ã˜ã‚å°ã•ãã™ã‚‹ã‹ã€ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç‰ˆãƒ„ãƒ¼ãƒ«ç­‰ã®åˆ©ç”¨ã‚’ã”æ¤œè¨ãã ã•ã„ã€‚
    </div>

    <script>
        let pdfData = null;
        let originalFileName = "";
        let totalPages = 0;
        let totalFileSize = 0;
        let splitMode = 'page';

        const fileInput = document.getElementById('file_input');
        const dropZone = document.getElementById('drop_zone');
        const status = document.getElementById('status');
        const fileInfo = document.getElementById('file_info');
        const step2Area = document.getElementById('step2_area');
        const numSplits = document.getElementById('num_splits');
        const splitBtn = document.getElementById('split_btn');
        const pBar = document.getElementById('p_bar');
        const pFill = document.getElementById('p_fill');

        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = (e) => handleFile(e.target.files[0]);
        dropZone.ondrop = (e) => { e.preventDefault(); handleFile(e.dataTransfer.files[0]); };
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.backgroundColor = '#e8f0fe'; };
        dropZone.ondragleave = () => dropZone.style.backgroundColor = '#fff';

        async function handleFile(file) {
            if (!file || file.type !== "application/pdf") return;

            originalFileName = file.name.replace(".pdf", "");
            totalFileSize = file.size;
            pBar.style.display = "block";
            status.innerText = "èª­ã¿è¾¼ã¿ä¸­...";
            status.className = "";

            // 200MBè¶…ãˆã®å ´åˆã®è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            if (totalFileSize > 200 * 1024 * 1024) {
                status.innerHTML = `<span class="warning">âš ï¸ ${(totalFileSize/1024/1024).toFixed(1)}MB ã®å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œçŸ¥ã—ã¾ã—ãŸã€‚<br>ãƒ–ãƒ©ã‚¦ã‚¶ã®é™ç•Œã«æŒ‘æˆ¦ã—ã¾ã™ãŒã€å¤±æ•—ã—ãŸå ´åˆã¯ã”å®¹èµ¦ãã ã•ã„ã€‚</span>`;
            }

            const reader = new FileReader();
            reader.onprogress = (e) => {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    pFill.style.width = percent + "%";
                    pFill.innerText = `èª­è¾¼: ${percent}%`;
                }
            };

            reader.onload = async (e) => {
                try {
                    pdfData = e.target.result;
                    const pdfDoc = await PDFLib.PDFDocument.load(pdfData, { ignoreEncryption: true });
                    totalPages = pdfDoc.getPageCount();
                    fileInfo.innerText = `ğŸ“„ ${file.name} (${(totalFileSize/1024/1024).toFixed(1)} MB / ${totalPages} ãƒšãƒ¼ã‚¸)`;
                    if (status.className !== "warning") status.innerText = "èª­ã¿è¾¼ã¿å®Œäº†";
                    step2Area.style.display = "block";
                    updateSplitUI();
                } catch (err) {
                    status.innerText = "PDFã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
                    status.className = "error";
                }
            };
            reader.readAsArrayBuffer(file);
        }

        document.getElementById('mode_page').onclick = () => {
            splitMode = 'page';
            document.getElementById('mode_page').classList.add('active');
            document.getElementById('mode_size').classList.remove('active');
            document.getElementById('page_setting').style.display = 'block';
            document.getElementById('size_setting').style.display = 'none';
        };

        document.getElementById('mode_size').onclick = () => {
            splitMode = 'size';
            document.getElementById('mode_size').classList.add('active');
            document.getElementById('mode_page').classList.remove('active');
            document.getElementById('size_setting').style.display = 'block';
            document.getElementById('page_setting').style.display = 'none';
        };

        function updateSplitUI() {
            if (splitMode !== 'page') return;
            const num = parseInt(numSplits.value) || 2;
            const container = document.getElementById('split_points_container');
            const step = Math.ceil(totalPages / num);
            let html = "<strong>åˆ†å‰²ä½ç½®ã®èª¿æ•´:</strong>";
            for (let i = 1; i < num; i++) {
                let val = Math.floor(step * i);
                html += `<div class="split-point-item">${i}ã¤ç›®ã®åŒºåˆ‡ã‚Š: <input type="number" class="split-point" value="${val}" min="1" max="${totalPages-1}"> ãƒšãƒ¼ã‚¸ã®å¾Œ</div>`;
            }
            container.innerHTML = html;
        }
        numSplits.oninput = updateSplitUI;

        splitBtn.onclick = async () => {
            splitBtn.disabled = true;
            document.getElementById('finish_msg').style.display = "none";
            status.innerText = "åˆ†å‰²ä¸­... ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„";
            
            try {
                const srcDoc = await PDFLib.PDFDocument.load(pdfData);
                let ranges = [];

                if (splitMode === 'page') {
                    const inputs = Array.from(document.querySelectorAll('.split-point')).map(el => parseInt(el.value));
                    const points = [0, ...new Set(inputs.filter(v => v > 0 && v < totalPages)), totalPages].sort((a,b) => a-b);
                    for (let i = 0; i < points.length - 1; i++) {
                        ranges.push({ start: points[i], end: points[i+1] });
                    }
                } else {
                    const limitMB = parseInt(document.getElementById('size_limit').value);
                    const pagesPerFile = Math.max(1, Math.floor((limitMB * 1024 * 1024) / (totalFileSize / totalPages)));
                    for (let i = 0; i < totalPages; i += pagesPerFile) {
                        ranges.push({ start: i, end: Math.min(i + pagesPerFile, totalPages) });
                    }
                }

                for (let i = 0; i < ranges.length; i++) {
                    const { start, end } = ranges[i];
                    const newDoc = await PDFLib.PDFDocument.create();
                    const indices = Array.from({length: end - start}, (_, k) => start + k);
                    const copiedPages = await newDoc.copyPages(srcDoc, indices);
                    copiedPages.forEach(p => newDoc.addPage(p));
                    
                    const pdfBytes = await newDoc.save();
                    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${originalFileName}_part${i+1}.pdf`;
                    a.click();
                    
                    setTimeout(() => URL.revokeObjectURL(url), 1000);

                    const percent = Math.round(((i+1)/ranges.length)*100);
                    pFill.style.width = percent + "%";
                    pFill.innerText = `å‡¦ç†ä¸­: ${percent}%`;
                    await new Promise(r => setTimeout(r, 500)); // ãƒ¡ãƒ¢ãƒªè§£æ”¾ã®ãŸã‚ã®å¾…ã¡æ™‚é–“ã‚’å°‘ã—é•·ã‚ã«
                }
                
                status.innerText = "âœ… å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚";
                status.className = "success";
                document.getElementById('finish_msg').style.display = "block";
            } catch (err) {
                status.innerText = "ãƒ¡ãƒ¢ãƒªä¸è¶³ç­‰ã®ç†ç”±ã«ã‚ˆã‚Šã€å‡¦ç†ã‚’å®Œé‚ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";
                status.className = "error";
            } finally {
                splitBtn.disabled = false;
            }
        };
    </script>
</body>
</html>
