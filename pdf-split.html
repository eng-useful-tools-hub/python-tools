<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>PDFåˆ†å‰²ãƒ„ãƒ¼ãƒ«</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2023.11.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2023.11.1/core.js"></script>
    
    <py-config>
        packages = ["pypdf"]
    </py-config>

    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; line-height: 1.6; }
        .card { background: #f6f8fa; padding: 20px; border-radius: 8px; border: 1px solid #d0d7de; }
        input[type="file"], input[type="number"], button { width: 100%; padding: 10px; margin: 10px 0; box-sizing: border-box; font-size: 16px; }
        button { background-color: #0969da; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background-color: #0550ae; }
        #download_link { display: none; text-align: center; background-color: #2ea44f; color: white; padding: 12px; text-decoration: none; border-radius: 5px; font-weight: bold; margin-top: 15px; }
        #download_link:hover { background-color: #2c974b; }
        #status { color: #d1242f; font-weight: bold; }
    </style>
</head>
<body>
    <h1>ğŸ“„ PDF åˆ†å‰²ï¼ˆæŠ½å‡ºï¼‰ãƒ„ãƒ¼ãƒ«</h1>
    <p>ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã•ã‚Œãšã€ã™ã¹ã¦ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§å®‰å…¨ã«å‡¦ç†ã•ã‚Œã¾ã™ã€‚</p>

    <div class="card">
        <label>1. åˆ†å‰²ã—ãŸã„PDFã‚’é¸æŠ:</label>
        <input type="file" id="pdf_upload" accept="application/pdf">

        <label>2. æŠ½å‡ºã™ã‚‹ãƒšãƒ¼ã‚¸ç¯„å›²:</label>
        <div style="display: flex; gap: 10px;">
            <input type="number" id="start_page" placeholder="é–‹å§‹ (ä¾‹: 1)" min="1">
            <span style="padding-top: 20px;">ã€œ</span>
            <input type="number" id="end_page" placeholder="çµ‚äº† (ä¾‹: 5)" min="1">
        </div>

        <button id="split_btn" py-click="split_pdf">âœ‚ï¸ æŒ‡å®šãƒšãƒ¼ã‚¸ã‚’åˆ‡ã‚Šå‡ºã™</button>
        
        <p id="status"></p>
        <a id="download_link">â¬‡ï¸ åˆ†å‰²ã•ã‚ŒãŸPDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
    </div>

    <script type="py">
        import asyncio
        import io
        from js import document, Uint8Array, Blob, URL
        from pypdf import PdfReader, PdfWriter

        async def split_pdf(event):
            status_text = document.getElementById("status")
            download_link = document.getElementById("download_link")
            
            # åˆæœŸåŒ–
            status_text.innerText = "å‡¦ç†ä¸­...ï¼ˆå°‘ã—ãŠå¾…ã¡ãã ã•ã„ï¼‰"
            download_link.style.display = "none"
            
            try:
                # ãƒ•ã‚¡ã‚¤ãƒ«ã®å–å¾—
                file_input = document.getElementById("pdf_upload")
                if not file_input.files.length:
                    status_text.innerText = "ã‚¨ãƒ©ãƒ¼: PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"
                    return
                
                file = file_input.files.item(0)
                
                # ãƒšãƒ¼ã‚¸ã®å–å¾—
                start_val = document.getElementById("start_page").value
                end_val = document.getElementById("end_page").value
                
                if not start_val or not end_val:
                    status_text.innerText = "ã‚¨ãƒ©ãƒ¼: é–‹å§‹ãƒšãƒ¼ã‚¸ã¨çµ‚äº†ãƒšãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"
                    return
                
                start_page = int(start_val) - 1  # Pythonã¯0ã‹ã‚‰æ•°ãˆã‚‹ãŸã‚-1
                end_page = int(end_val)

                # JavaScriptã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’Pythonã§æ‰±ãˆã‚‹ã‚ˆã†ã«å¤‰æ›
                array_buffer = await file.arrayBuffer()
                js_array = Uint8Array.new(array_buffer)
                pdf_bytes = bytes(js_array)
                
                # PDFã®èª­ã¿è¾¼ã¿ã¨åˆ†å‰²å‡¦ç†
                reader = PdfReader(io.BytesIO(pdf_bytes))
                writer = PdfWriter()
                
                # ãƒšãƒ¼ã‚¸ç¯„å›²ã®ãƒã‚§ãƒƒã‚¯
                total_pages = len(reader.pages)
                if start_page < 0 or end_page > total_pages or start_page >= end_page:
                    status_text.innerText = f"ã‚¨ãƒ©ãƒ¼: æ­£ã—ã„ãƒšãƒ¼ã‚¸ç¯„å›²ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚(å…¨{total_pages}ãƒšãƒ¼ã‚¸)"
                    return
                
                for i in range(start_page, end_page):
                    writer.add_page(reader.pages[i])
                
                # æ–°ã—ã„PDFãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
                output_stream = io.BytesIO()
                writer.write(output_stream)
                output_bytes = output_stream.getvalue()
                
                # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ã®ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆ (JavaScriptã®Blobã‚’åˆ©ç”¨)
                js_array_out = Uint8Array.new(len(output_bytes))
                js_array_out.assign(output_bytes)
                blob = Blob.new([js_array_out], type="application/pdf")
                url = URL.createObjectURL(blob)
                
                # ç”»é¢ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                download_link.href = url
                download_link.download = "split_document.pdf"
                download_link.style.display = "block"
                status_text.innerText = "âœ… å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚"
                
            except Exception as e:
                status_text.innerText = f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}"
    </script>
</body>
</html>
