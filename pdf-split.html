<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>é«˜æ©Ÿèƒ½ PDFåˆ†å‰²ãƒ„ãƒ¼ãƒ«</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2023.11.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2023.11.1/core.js"></script>
    
    <py-config>
        packages = ["pypdf"]
    </py-config>

    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 650px; margin: auto; line-height: 1.6; color: #333; }
        .card { background: #f6f8fa; padding: 25px; border-radius: 8px; border: 1px solid #d0d7de; margin-bottom: 20px;}
        
        #drop_zone { border: 2px dashed #0969da; border-radius: 10px; padding: 40px 20px; text-align: center; background-color: #fff; cursor: pointer; transition: background-color 0.2s; margin-bottom: 15px; }
        #drop_zone.dragover { background-color: #e1e4e8; }
        
        input[type="number"] { width: 80px; padding: 5px; margin: 0 5px; font-size: 16px; }
        button { background-color: #0969da; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; padding: 12px; font-size: 16px; margin-top: 15px;}
        button:hover { background-color: #0550ae; }
        
        #download_link { display: none; text-align: center; background-color: #2ea44f; color: white; padding: 15px; text-decoration: none; border-radius: 5px; font-weight: bold; margin-top: 15px; }
        #download_link:hover { background-color: #2c974b; }
        
        .info-text { color: #57606a; font-size: 0.9em; margin-top: 5px; }
        #status { color: #d1242f; font-weight: bold; text-align: center; }
        #file_info { font-weight: bold; margin-bottom: 15px; color: #0969da; }
    </style>
</head>
<body>
    <h1>âœ‚ï¸ é«˜æ©Ÿèƒ½ PDFåˆ†å‰²ãƒ„ãƒ¼ãƒ«</h1>
    <p>ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã•ã‚Œãšã€ãŠä½¿ã„ã®ç«¯æœ«ä¸Šã§å®‰å…¨ã«å‡¦ç†ã•ã‚Œã¾ã™ã€‚</p>

    <div class="card" id="step1_area">
        <h3>Step 1: PDFãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿</h3>
        <div id="drop_zone">
            ğŸ“‚ ã“ã“ã«PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—<br>ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
        </div>
        <input type="file" id="file_input" accept="application/pdf" style="display: none;" py-change="on_file_loaded">
        
        <div id="file_info"></div>
        <div id="status"></div>
    </div>

    <div class="card" id="step2_area" style="display: none;">
        <h3>Step 2: åˆ†å‰²è¨­å®š</h3>
        <label>â‘¢ ä½•åˆ†å‰²ã«ã—ã¾ã™ã‹ï¼Ÿ: 
            <input type="number" id="num_splits" value="2" min="2" max="20" py-change="update_split_inputs"> åˆ†å‰²
        </label>
        
        <div id="split_points_container" style="margin-top: 15px; padding: 15px; background: #fff; border: 1px solid #ddd; border-radius: 5px;">
        </div>

        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px dashed #ccc;">
            <p style="font-weight: bold;">â‘¤ ä¿å­˜å…ˆã®ç¢ºèª</p>
            <p class="info-text">â€»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ä»•æ§˜ä¸Šã€ä¿å­˜å…ˆã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®æ¨™æº–è¨­å®šï¼ˆé€šå¸¸ã¯ã€Œãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ãƒ•ã‚©ãƒ«ãƒ€ï¼‰ã«ãªã‚Šã¾ã™ã€‚<br>â€»è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã«ãªã‚‹ãŸã‚ã€1ã¤ã®ZIPãƒ•ã‚¡ã‚¤ãƒ«ã«ã¾ã¨ã‚ã¦å‡ºåŠ›ã—ã¾ã™ã€‚</p>
        </div>

        <button id="split_btn" py-click="execute_split">å®Ÿè¡Œã—ã¦ZIPã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        <a id="download_link">â¬‡ï¸ ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã™ã‚‹</a>
    </div>

    <script>
        const dropZone = document.getElementById('drop_zone');
        const fileInput = document.getElementById('file_input');

        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files;
                // ä¿®æ­£ç®‡æ‰€ï¼šPyScriptãŒèªè­˜ã§ãã‚‹ã‚ˆã†ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã•ã›ã¾ã™
                fileInput.dispatchEvent(new Event('change', { bubbles: true }));
            }
        });
    </script>

    <script type="py">
        import asyncio
        import io
        import math
        import zipfile
        from js import document, Uint8Array, Blob, URL
        from pypdf import PdfReader, PdfWriter

        pdf_bytes = None
        total_pages = 0
        file_name = ""

        def format_size(size_in_bytes):
            if size_in_bytes < 1024 * 1024:
                return f"{size_in_bytes / 1024:.1f} KB"
            return f"{size_in_bytes / (1024 * 1024):.2f} MB"

        async def on_file_loaded(event):
            global pdf_bytes, total_pages, file_name
            status_text = document.getElementById("status")
            file_input = document.getElementById("file_input")
            
            if not file_input.files.length:
                return
            
            file = file_input.files.item(0)
            file_name = file.name
            
            status_text.innerText = "PDFã‚’è§£æä¸­..."
            document.getElementById("step2_area").style.display = "none"
            document.getElementById("download_link").style.display = "none"
            
            try:
                array_buffer = await file.arrayBuffer()
                js_array = Uint8Array.new(array_buffer)
                pdf_bytes = bytes(js_array)
                
                reader = PdfReader(io.BytesIO(pdf_bytes))
                total_pages = len(reader.pages)
                
                info_text = f"ğŸ“„ {file_name} (ã‚µã‚¤ã‚º: {format_size(file.size)} / å…¨ {total_pages} ãƒšãƒ¼ã‚¸)"
                document.getElementById("file_info").innerText = info_text
                status_text.innerText = ""
                
                document.getElementById("step2_area").style.display = "block"
                update_split_inputs(None)
                
            except Exception as e:
                status_text.innerText = f"ã‚¨ãƒ©ãƒ¼: PDFã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°: {str(e)}"

        def update_split_inputs(event):
            num_splits_str = document.getElementById("num_splits").value
            if not num_splits_str: return
            
            num_splits = int(num_splits_str)
            container = document.getElementById("split_points_container")
            
            if num_splits < 2:
                container.innerHTML = "<p style='color:red;'>2åˆ†å‰²ä»¥ä¸Šã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚</p>"
                return
            if num_splits > total_pages:
                container.innerHTML = "<p style='color:red;'>ç·ãƒšãƒ¼ã‚¸æ•°ä»¥ä¸Šã®åˆ†å‰²ã¯ã§ãã¾ã›ã‚“ã€‚</p>"
                return

            html = "<p class='info-text'>â‘£ ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã®ã€Œç›´å¾Œã€ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŒºåˆ‡ã‚Šã¾ã™ã€‚<br>ï¼ˆå¿…è¦ã«å¿œã˜ã¦æ•°å­—ã‚’æ›¸ãæ›ãˆã¦èª¿æ•´ã§ãã¾ã™ï¼‰</p>"
            step = total_pages / num_splits
            
            for i in range(1, num_splits):
                default_point = math.floor(step * i)
                html += f"<div style='margin-bottom:8px;'>åˆ†å‰²ç‚¹ {i}: <input type='number' class='split-point' value='{default_point}' min='1' max='{total_pages - 1}'> ãƒšãƒ¼ã‚¸ç›®ã®ç›´å¾Œ</div>"
            
            container.innerHTML = html

        async def execute_split(event):
            status_text = document.getElementById("status")
            status_text.innerText = "åˆ†å‰²ãƒ»åœ§ç¸®å‡¦ç†ä¸­...ï¼ˆå°‘ã—ãŠå¾…ã¡ãã ã•ã„ï¼‰"
            document.getElementById("download_link").style.display = "none"
            
            try:
                num_splits = int(document.getElementById("num_splits").value)
                split_inputs = document.querySelectorAll(".split-point")
                
                breakpoints = []
                for inp in split_inputs:
                    breakpoints.append(int(inp.value))
                
                if any(p < 1 or p >= total_pages for p in breakpoints):
                    status_text.innerText = "ã‚¨ãƒ©ãƒ¼: å­˜åœ¨ã—ãªã„ãƒšãƒ¼ã‚¸ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã™ã€‚"
                    return

                reader = PdfReader(io.BytesIO(pdf_bytes))
                zip_buffer = io.BytesIO()
                base_name = file_name.replace(".pdf", "")
                
                with zipfile.ZipFile(zip_buffer, "a", zipfile.ZIP_DEFLATED, False) as zip_file:
                    start_p = 0
                    for i in range(num_splits):
                        end_p = breakpoints[i] if i < len(breakpoints) else total_pages
                        
                        writer = PdfWriter()
                        for p in range(start_p, end_p):
                            writer.add_page(reader.pages[p])
                        
                        pdf_out = io.BytesIO()
                        writer.write(pdf_out)
                        
                        part_name = f"{base_name}_part{i+1} ({start_p+1}-{end_p}page).pdf"
                        zip_file.writestr(part_name, pdf_out.getvalue())
                        
                        start_p = end_p
                
                zip_bytes = zip_buffer.getvalue()
                js_array_out = Uint8Array.new(len(zip_bytes))
                js_array_out.assign(zip_bytes)
                blob = Blob.new([js_array_out], type="application/zip")
                url = URL.createObjectURL(blob)
                
                dl_link = document.getElementById("download_link")
                dl_link.href = url
                dl_link.download = f"{base_name}_split.zip"
                dl_link.style.display = "block"
                
                status_text.innerText = "âœ… å®Œäº†ã—ã¾ã—ãŸï¼ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚"
                
            except Exception as e:
                status_text.innerText = f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}"
    </script>
</body>
</html>
