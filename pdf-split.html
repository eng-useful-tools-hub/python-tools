<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>PDFåˆ†å‰²ãƒ—ãƒ­ï¼šå‡ç­‰ãƒãƒ©ãƒ³ã‚¹ãƒ¢ãƒ‡ãƒ«</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2023.11.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2023.11.1/core.js"></script>
    <py-config>
        packages = ["pypdf"]
    </py-config>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; padding: 20px; max-width: 700px; margin: auto; background-color: #f4f7f9; color: #333; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #e1e4e8; }
        h1 { color: #0969da; text-align: center; margin-bottom: 30px; }
        #drop_zone { border: 2px dashed #0969da; border-radius: 12px; padding: 40px; text-align: center; background-color: #f0f7ff; cursor: pointer; transition: 0.3s; margin-bottom: 15px; }
        #drop_zone:hover { border-color: #0550ae; background-color: #e8f2ff; }
        .mode-switch { display: flex; gap: 10px; margin-bottom: 20px; background: #f1f3f5; padding: 5px; border-radius: 10px; }
        .mode-switch label { flex: 1; text-align: center; padding: 12px; cursor: pointer; border-radius: 8px; font-weight: bold; transition: 0.2s; }
        .mode-switch input { display: none; }
        .mode-switch input:checked + span { background: white; color: #0969da; display: block; border-radius: 6px; padding: 12px; margin: -12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .input-group { margin: 20px 0; padding: 15px; border-left: 5px solid #0969da; background: #f8f9fa; }
        button { background-color: #0969da; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; padding: 16px; font-size: 16px; box-shadow: 0 4px 12px rgba(9, 105, 218, 0.3); }
        button:hover { background-color: #0550ae; transform: translateY(-1px); }
        #download_link { display: none; text-align: center; background-color: #2ea44f; color: white; padding: 15px; text-decoration: none; border-radius: 8px; font-weight: bold; margin-top: 15px; box-shadow: 0 4px 12px rgba(46, 164, 79, 0.3); }
        #status { color: #d1242f; font-weight: bold; text-align: center; margin-top: 15px; }
        .info-badge { background: #e7f3ff; color: #0969da; padding: 4px 10px; border-radius: 20px; font-size: 0.85em; margin-right: 5px; }
    </style>
</head>
<body>
    <h1>âœ‚ï¸ PDFåˆ†å‰²ãƒ—ãƒ­ (å‡ç­‰ãƒãƒ©ãƒ³ã‚¹ç‰ˆ)</h1>
    
    <div class="card">
        <div id="drop_zone">ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦èª­ã¿è¾¼ã¿</div>
        <input type="file" id="file_input" accept="application/pdf" style="display: none;" py-change="on_file_loaded">
        <div id="file_info" style="margin-top:15px; text-align:center;"></div>
        <div id="status"></div>
    </div>

    <div id="step2_area" class="card" style="display: none;">
        <h3>åˆ†å‰²è¨­å®š</h3>
        <div class="mode-switch">
            <label><input type="radio" name="mode" value="page" checked py-change="update_ui"><span>ğŸ“„ ãƒšãƒ¼ã‚¸æ•°ã§å‡ç­‰ã«</span></label>
            <label><input type="radio" name="mode" value="size" py-change="update_ui"><span>âš–ï¸ å®¹é‡(MB)ã§å‡ç­‰ã«</span></label>
        </div>

        <div id="setting_input_area" class="input-group"></div>

        <div id="preview_area" style="font-size: 0.9em; color: #555; line-height: 1.8;"></div>

        <button id="split_btn" style="margin-top:20px;" py-click="execute_split">ã“ã®æ§‹æˆã§åˆ†å‰²ã‚’å®Ÿè¡Œ</button>
        <a id="download_link">â¬‡ï¸ ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
    </div>

    <script>
        const dropZone = document.getElementById('drop_zone');
        const fileInput = document.getElementById('file_input');
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            if (e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files;
                fileInput.dispatchEvent(new Event('change', { bubbles: true }));
            }
        });
    </script>

    <script type="py">
        import io, math, zipfile
        from js import document, Uint8Array, Blob, URL
        from pypdf import PdfReader, PdfWriter

        pdf_bytes = None
        total_pages = 0
        file_name = ""
        original_size_mb = 0

        async def on_file_loaded(event):
            global pdf_bytes, total_pages, file_name, original_size_mb
            file = document.getElementById("file_input").files.item(0)
            if not file: return
            file_name = file.name
            original_size_mb = file.size / (1024 * 1024)
            
            array_buffer = await file.arrayBuffer()
            pdf_bytes = bytes(Uint8Array.new(array_buffer))
            reader = PdfReader(io.BytesIO(pdf_bytes))
            total_pages = len(reader.pages)
            
            document.getElementById("file_info").innerHTML = f"<b>{file_name}</b><br><br><span class='info-badge'>{total_pages}ãƒšãƒ¼ã‚¸</span><span class='info-badge'>{original_size_mb:.2f} MB</span>"
            document.getElementById("step2_area").style.display = "block"
            update_ui(None)

        def update_ui(event):
            mode = document.querySelector('input[name="mode"]:checked').value
            area = document.getElementById("setting_input_area")
            if mode == "page":
                area.innerHTML = 'ä½•åˆ†å‰²ã«ã—ã¾ã™ã‹ï¼Ÿ: <input type="number" id="val_input" value="3" min="2" max="'+str(total_pages)+'" style="padding:8px; border-radius:4px; border:1px solid #ccc; width:60px;" py-change="refresh_preview"> ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«'
            else:
                area.innerHTML = '1ãƒ•ã‚¡ã‚¤ãƒ«ã‚ãŸã‚Šç´„ä½•MBã«ã—ã¾ã™ã‹ï¼Ÿ: <input type="number" id="val_input" value="'+str(round(original_size_mb/3, 1))+'" step="0.1" min="0.1" style="padding:8px; border-radius:4px; border:1px solid #ccc; width:70px;" py-change="refresh_preview"> MB'
            refresh_preview(None)

        def calculate_split_points():
            mode = document.querySelector('input[name="mode"]:checked').value
            val = float(document.getElementById("val_input").value or 0.1)
            points = []
            
            if mode == "page":
                num_files = int(val)
                step = total_pages / num_files
                for i in range(1, num_files):
                    points.append(math.floor(step * i))
            else:
                # å®¹é‡å‡ç­‰åŒ–ãƒ­ã‚¸ãƒƒã‚¯
                num_files = math.ceil(original_size_mb / val)
                if num_files < 2: num_files = 2
                target_size_per_file = original_size_mb / num_files
                page_avg = original_size_mb / total_pages
                
                for i in range(1, num_files):
                    # ç†æƒ³çš„ãªç´¯ç©å®¹é‡ã«æœ€ã‚‚è¿‘ã„ãƒšãƒ¼ã‚¸ç•ªå·ã‚’è¨ˆç®—
                    target_cum_size = target_size_per_file * i
                    best_page = round(target_cum_size / page_avg)
                    if best_page < 1: best_page = 1
                    if best_page >= total_pages: break
                    points.append(best_page)
            
            return sorted(list(set(points)))

        def refresh_preview(event):
            points = calculate_split_points()
            preview = document.getElementById("preview_area")
            
            lines = []
            start = 1
            for i, p in enumerate(points):
                lines.append(f"ãƒ•ã‚¡ã‚¤ãƒ« {i+1}: {start}ï½{p} ãƒšãƒ¼ã‚¸")
                start = p + 1
            lines.append(f"ãƒ•ã‚¡ã‚¤ãƒ« {len(points)+1}: {start}ï½{total_pages} ãƒšãƒ¼ã‚¸")
            
            preview.innerHTML = "<b>åˆ†å‰²ã®æ§‹æˆäºˆå®š:</b><br>" + "<br>".join(lines)

        async def execute_split(event):
            status = document.getElementById("status")
            status.innerText = "æœ€é©åŒ–åˆ†å‰²ã‚’å®Ÿè¡Œä¸­..."
            document.getElementById("download_link").style.display = "none"
            
            try:
                points = calculate_split_points()
                reader = PdfReader(io.BytesIO(pdf_bytes))
                zip_buffer = io.BytesIO()
                
                with zipfile.ZipFile(zip_buffer, "a", zipfile.ZIP_DEFLATED) as zf:
                    start = 0
                    for i, p in enumerate(points + [total_pages]):
                        if start >= total_pages: break
                        writer = PdfWriter()
                        for page_idx in range(start, p):
                            writer.add_page(reader.pages[page_idx])
                        
                        out = io.BytesIO()
                        writer.write(out)
                        zf.writestr(f"part_{i+1}_{start+1}-{p}page.pdf", out.getvalue())
                        start = p
                
                blob = Blob.new([Uint8Array.new(zip_buffer.getvalue())], type="application/zip")
                link = document.getElementById("download_link")
                link.href = URL.createObjectURL(blob)
                link.download = f"balanced_split_{file_name.replace('.pdf', '')}.zip"
                link.style.display = "block"
                status.innerText = "âœ… å‡ç­‰åˆ†å‰²ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
            except Exception as e:
                status.innerText = f"ã‚¨ãƒ©ãƒ¼: {e}"
    </script>
</body>
</html>
