<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>PDFåˆ†å‰²ãƒ„ãƒ¼ãƒ« v1.11</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; max-width: 750px; margin: auto; line-height: 1.6; color: #333; background-color: #f8f9fa; }
        h1 { color: #1a73e8; border-bottom: 2px solid #1a73e8; padding-bottom: 10px; margin-bottom: 5px; }
        .version-tag { text-align: right; font-size: 0.8em; color: #777; margin-bottom: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px;}
        #drop_zone { border: 2px dashed #1a73e8; border-radius: 10px; padding: 40px 20px; text-align: center; background: #fff; cursor: pointer; transition: 0.2s; }
        #drop_zone:hover { background: #f1f3f4; }
        .mode-selector { display: flex; gap: 10px; margin-bottom: 20px; }
        .mode-btn { flex: 1; padding: 10px; border: 2px solid #dadce0; border-radius: 8px; cursor: pointer; background: white; font-weight: bold; transition: 0.2s; }
        .mode-btn.active { border-color: #1a73e8; background: #e8f0fe; color: #1a73e8; }
        #status { font-weight: bold; margin: 15px 0; text-align: center; }
        .error { color: #d93025; }
        .success { color: #1e8e3e; }
        button#split_btn { background-color: #1a73e8; color: white; border: none; border-radius: 6px; cursor: pointer; width: 100%; padding: 15px; font-size: 16px; font-weight: bold; }
        button#split_btn:hover { background-color: #174ea6; }
        button#split_btn:disabled { background-color: #dadce0; }
        #download_link { display: none; text-align: center; background-color: #1e8e3e; color: white; padding: 15px; text-decoration: none; border-radius: 6px; font-weight: bold; margin-top: 15px; }
        .progress-bar { width: 100%; background: #eee; height: 8px; border-radius: 4px; overflow: hidden; display: none; margin-top: 15px; }
        .progress-fill { width: 0%; background: #1a73e8; height: 100%; transition: width 0.1s; }
        .input-group { margin-bottom: 15px; }
        input[type="number"] { width: 80px; padding: 8px; border: 1px solid #dadce0; border-radius: 4px; }
    </style>
</head>
<body>

    <h1>âœ‚ï¸ PDFåˆ†å‰²ãƒ„ãƒ¼ãƒ«</h1>
    <div class="version-tag">Version 1.11 (JS Hybrid Engine / Multi-Mode)</div>

    <div class="card">
        <h3>1. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</h3>
        <div id="drop_zone">ğŸ“‚ PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ— ã¾ãŸã¯ ã‚¯ãƒªãƒƒã‚¯</div>
        <input type="file" id="file_input" accept="application/pdf" style="display: none;">
        <div id="file_info" style="margin-top:15px; font-weight:bold; color: #1a73e8;"></div>
        <div id="status"></div>
        <div class="progress-bar" id="p_bar"><div class="progress-fill" id="p_fill"></div></div>
    </div>

    <div id="step2_area" class="card" style="display: none;">
        <h3>2. åˆ†å‰²æ–¹æ³•ã‚’é¸æŠ</h3>
        <div class="mode-selector">
            <button class="mode-btn active" id="mode_page">ãƒšãƒ¼ã‚¸æ•°ã§åˆ†å‰²</button>
            <button class="mode-btn" id="mode_size">å®¹é‡(MB)ã§åˆ†å‰²</button>
        </div>

        <div id="page_setting" class="input-group">
            ä½•åˆ†å‰²ã«ã—ã¾ã™ã‹ï¼Ÿ: <input type="number" id="num_splits" value="2" min="2" max="100"> åˆ†å‰²
        </div>

        <div id="size_setting" class="input-group" style="display: none;">
            1ãƒ•ã‚¡ã‚¤ãƒ«ã‚ãŸã‚Šã®ä¸Šé™: <input type="number" id="size_limit" value="10" min="1"> MB
            <p style="font-size: 0.8em; color: #666;">â€»å®¹é‡ã«åã¾ã‚‹ã‚ˆã†è‡ªå‹•ã§ãƒšãƒ¼ã‚¸ã‚’å‰²ã‚ŠæŒ¯ã‚Šã¾ã™ã€‚</p>
        </div>

        <div id="split_preview" style="margin: 15px 0; font-size: 0.85em; background: #f1f3f4; padding: 15px; border-radius: 8px;"></div>
        
        <button id="split_btn">åˆ†å‰²å‡¦ç†ã‚’å®Ÿè¡Œã—ã¦ZIPä¿å­˜</button>
        <a id="download_link">â¬‡ï¸ ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
    </div>

    <script>
        let pdfData = null;
        let originalFileName = "";
        let splitMode = 'page'; // 'page' or 'size'
        let totalFileSize = 0;

        const fileInput = document.getElementById('file_input');
        const dropZone = document.getElementById('drop_zone');
        const status = document.getElementById('status');
        const fileInfo = document.getElementById('file_info');
        const step2Area = document.getElementById('step2_area');
        const splitBtn = document.getElementById('split_btn');
        const preview = document.getElementById('split_preview');

        // â‘  ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        document.getElementById('mode_page').onclick = () => {
            splitMode = 'page';
            document.getElementById('mode_page').classList.add('active');
            document.getElementById('mode_size').classList.remove('active');
            document.getElementById('page_setting').style.display = 'block';
            document.getElementById('size_setting').style.display = 'none';
            updatePreview();
        };

        document.getElementById('mode_size').onclick = () => {
            splitMode = 'size';
            document.getElementById('mode_size').classList.add('active');
            document.getElementById('mode_page').classList.remove('active');
            document.getElementById('size_setting').style.display = 'block';
            document.getElementById('page_setting').style.display = 'none';
            updatePreview();
        };

        // â‘¡ ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
        dropZone.onclick = () => fileInput.click();
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.backgroundColor = '#e8f0fe'; };
        dropZone.ondragleave = () => dropZone.style.backgroundColor = '#fff';
        dropZone.ondrop = (e) => {
            e.preventDefault();
            handleFile(e.dataTransfer.files[0]);
        };
        fileInput.onchange = (e) => handleFile(e.target.files[0]);

        async function handleFile(file) {
            if (!file || file.type !== "application/pdf") return;
            originalFileName = file.name.replace(".pdf", "");
            totalFileSize = file.size;
            status.innerText = "èª­ã¿è¾¼ã¿ä¸­...";
            
            try {
                pdfData = await file.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(pdfData, { ignoreEncryption: true });
                const totalPages = pdfDoc.getPageCount();
                fileInfo.innerText = `ğŸ“„ ${file.name} (${(totalFileSize/1024/1024).toFixed(1)} MB / ${totalPages} ãƒšãƒ¼ã‚¸)`;
                status.innerText = "";
                step2Area.style.display = "block";
                updatePreview();
            } catch (err) {
                status.innerText = "ã‚¨ãƒ©ãƒ¼: PDFã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
            }
        }

        // â‘¢ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        async function updatePreview() {
            if (!pdfData) return;
            const pdfDoc = await PDFLib.PDFDocument.load(pdfData);
            const total = pdfDoc.getPageCount();

            if (splitMode === 'page') {
                const num = parseInt(document.getElementById('num_splits').value) || 2;
                const step = Math.ceil(total / num);
                preview.innerHTML = `<strong>åˆ†å‰²ã‚¤ãƒ¡ãƒ¼ã‚¸:</strong> ç´„ ${step} ãƒšãƒ¼ã‚¸ãšã¤ ${num} å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚`;
            } else {
                const limit = parseInt(document.getElementById('size_limit').value) || 10;
                const estFiles = Math.ceil((totalFileSize/1024/1024) / limit);
                preview.innerHTML = `<strong>åˆ†å‰²ã‚¤ãƒ¡ãƒ¼ã‚¸:</strong> å„ãƒ•ã‚¡ã‚¤ãƒ«æœ€å¤§ ${limit}MB ã‚’ç›®å®‰ã«ã€ç´„ ${estFiles} å€‹å‰å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ†å‰²ã—ã¾ã™ã€‚`;
            }
        }

        document.getElementById('num_splits').oninput = updatePreview;
        document.getElementById('size_limit').oninput = updatePreview;

        // â‘£ åˆ†å‰²å®Ÿè¡Œ
        splitBtn.onclick = async () => {
            status.innerText = "å‡¦ç†ä¸­...";
            splitBtn.disabled = true;
            document.getElementById('p_bar').style.display = "block";
            const pFill = document.getElementById('p_fill');
            
            try {
                const srcDoc = await PDFLib.PDFDocument.load(pdfData);
                const totalPages = srcDoc.getPageCount();
                const zip = new JSZip();
                let ranges = [];

                if (splitMode === 'page') {
                    const num = parseInt(document.getElementById('num_splits').value);
                    const step = Math.ceil(totalPages / num);
                    for (let i = 0; i < totalPages; i += step) {
                        ranges.push({ start: i, end: Math.min(i + step, totalPages) });
                    }
                } else {
                    // å®¹é‡ãƒ™ãƒ¼ã‚¹ã®ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆç°¡æ˜“è¨ˆç®—ï¼‰
                    const limitMB = parseInt(document.getElementById('size_limit').value);
                    const avgSizePerPage = totalFileSize / totalPages;
                    const pagesPerFile = Math.max(1, Math.floor((limitMB * 1024 * 1024) / avgSizePerPage));
                    for (let i = 0; i < totalPages; i += pagesPerFile) {
                        ranges.push({ start: i, end: Math.min(i + pagesPerFile, totalPages) });
                    }
                }

                for (let i = 0; i < ranges.length; i++) {
                    const { start, end } = ranges[i];
                    const newDoc = await PDFLib.PDFDocument.create();
                    const indices = Array.from({length: end - start}, (_, k) => start + k);
                    const copiedPages = await newDoc.copyPages(srcDoc, indices);
                    copiedPages.forEach(p => newDoc.addPage(p));
                    
                    const pdfBytes = await newDoc.save();
                    zip.file(`${originalFileName}_part${i+1}.pdf`, pdfBytes);
                    pFill.style.width = `${((i+1)/ranges.length)*100}%`;
                    await new Promise(r => setTimeout(r, 10));
                }
                
                const zipBlob = await zip.generateAsync({ type: "blob" });
                const dlLink = document.getElementById('download_link');
                dlLink.href = URL.createObjectURL(zipBlob);
                dlLink.download = `${originalFileName}_split.zip`;
                dlLink.style.display = "block";
                status.innerText = "âœ… åˆ†å‰²å®Œäº†ï¼";
            } catch (err) {
                status.innerText = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
                console.error(err);
            } finally {
                splitBtn.disabled = false;
            }
        };
    </script>
</body>
</html>
