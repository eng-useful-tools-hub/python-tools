<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>é«˜æ©Ÿèƒ½ PDFåˆ†å‰²ãƒ„ãƒ¼ãƒ« (å¤§å®¹é‡æœ€é©åŒ–ç‰ˆ)</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2023.11.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2023.11.1/core.js"></script>
    
    <py-config>
        packages = ["pypdf"]
    </py-config>

    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 700px; margin: auto; line-height: 1.6; color: #333; background-color: #f4f7f9; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px;}
        .limit-tag { background: #0969da; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; vertical-align: middle; }
        #drop_zone { border: 2px dashed #0969da; border-radius: 10px; padding: 40px; text-align: center; background: #fff; cursor: pointer; }
        #status { font-weight: bold; margin: 15px 0; text-align: center; min-height: 1.5em; }
        button { background-color: #0969da; color: white; border: none; border-radius: 6px; cursor: pointer; width: 100%; padding: 15px; font-size: 16px; font-weight: bold; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #download_link { display: none; text-align: center; background-color: #2ea44f; color: white; padding: 15px; text-decoration: none; border-radius: 6px; font-weight: bold; margin-top: 10px; }
        .progress-bar { width: 100%; background: #eee; height: 10px; border-radius: 5px; margin-top: 10px; display: none; }
        .progress-fill { width: 0%; background: #0969da; height: 100%; border-radius: 5px; transition: width 0.3s; }
    </style>
</head>
<body>

    <h1>âœ‚ï¸ PDFåˆ†å‰²ãƒ„ãƒ¼ãƒ« <span class="limit-tag">é«˜æ€§èƒ½ç‰ˆ</span></h1>

    <div class="card">
        <h3>1. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</h3>
        <p style="font-size: 0.85em; color: #666;">â€»æ•°ç™¾MBã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚‚å¯¾å¿œã€‚å‡¦ç†ã¯ã™ã¹ã¦ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§è¡Œã‚ã‚Œã¾ã™ã€‚</p>
        <div id="drop_zone">ğŸ“„ ã“ã“ã«PDFã‚’ãƒ‰ãƒ­ãƒƒãƒ— ã¾ãŸã¯ ã‚¯ãƒªãƒƒã‚¯</div>
        <input type="file" id="file_input" accept="application/pdf" style="display: none;" py-change="on_file_loaded">
        <div id="file_info" style="margin-top:15px; font-weight:bold; color: #0969da;"></div>
        <div id="status"></div>
        <div class="progress-bar" id="p_bar"><div class="progress-fill" id="p_fill"></div></div>
    </div>

    <div class="card" id="step2_area" style="display: none;">
        <h3>2. åˆ†å‰²è¨­å®š</h3>
        åˆ†å‰²æ•°: <input type="number" id="num_splits" value="2" min="2" max="100" style="width:60px;" py-change="update_split_inputs">
        <div id="split_points_container" style="margin: 15px 0; font-size: 0.9em;"></div>
        <button id="split_btn" py-click="execute_split">åˆ†å‰²å‡¦ç†ã‚’é–‹å§‹ã™ã‚‹</button>
        <a id="download_link">â¬‡ï¸ ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜</a>
    </div>

    <script>
        const dropZone = document.getElementById('drop_zone');
        const fileInput = document.getElementById('file_input');
        dropZone.onclick = () => fileInput.click();
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.background = '#e8f0fe'; };
        dropZone.ondragleave = () => dropZone.style.background = '#fff';
        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.style.background = '#fff';
            if (e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files;
                fileInput.dispatchEvent(new Event('change', { bubbles: true }));
            }
        };
    </script>

    <script type="py">
        import asyncio, io, math, zipfile
        from js import document, Uint8Array, Blob, URL
        from pypdf import PdfReader, PdfWriter

        # ã‚°ãƒ­ãƒ¼ãƒãƒ«ä¿æŒ
        raw_pdf_data = None
        file_name = ""

        async def on_file_loaded(event):
            global raw_pdf_data, file_name
            status = document.getElementById("status")
            file = document.getElementById("file_input").files.item(0)
            file_name = file.name
            status.innerText = "ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­..."
            
            try:
                # ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ°—ã«Pythonå´ã¸æŒã£ã¦ãã‚‹
                array_buffer = await file.arrayBuffer()
                raw_pdf_data = bytes(Uint8Array.new(array_buffer))
                
                # ãƒšãƒ¼ã‚¸æ•°ã ã‘å…ˆã«ç¢ºèª
                reader = PdfReader(io.BytesIO(raw_pdf_data))
                total = len(reader.pages)
                
                size_mb = len(raw_pdf_data) / (1024*1024)
                document.getElementById("file_info").innerText = f"ğŸ“„ {file_name} ({size_mb:.1f} MB / {total} ãƒšãƒ¼ã‚¸)"
                status.innerText = ""
                document.getElementById("step2_area").style.display = "block"
                update_split_inputs(None)
            except Exception as e:
                status.innerText = "èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤§ãã™ãã‚‹ã‹ã€ãƒ¡ãƒ¢ãƒªãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚"

        def update_split_inputs(event):
            num = int(document.getElementById("num_splits").value or 2)
            total = len(PdfReader(io.BytesIO(raw_pdf_data)).pages)
            container = document.getElementById("split_points_container")
            step = total / num
            html = "<strong>åŒºåˆ‡ã‚Šä½ç½®ã®èª¿æ•´:</strong>"
            for i in range(1, num):
                val = math.floor(step * i)
                html += f"<div>{i}ç•ªç›®: <input type='number' class='split-point' value='{val}' min='1' max='{total-1}'> ãƒšãƒ¼ã‚¸ã®å¾Œ</div>"
            container.innerHTML = html

        async def execute_split(event):
            status = document.getElementById("status")
            btn = document.getElementById("split_btn")
            p_bar = document.getElementById("p_bar")
            p_fill = document.getElementById("p_fill")
            
            status.innerText = "åˆ†å‰²ä¸­... ã—ã°ã‚‰ãã“ã®ã¾ã¾ãŠå¾…ã¡ãã ã•ã„"
            btn.disabled = True
            p_bar.style.display = "block"
            
            try:
                await asyncio.sleep(0.1)
                # å…ƒãƒ‡ãƒ¼ã‚¿ã¯ BytesIO ã§ä½¿ã„å›ã™ï¼ˆãƒ¡ãƒ¢ãƒªç¯€ç´„ï¼‰
                src_stream = io.BytesIO(raw_pdf_data)
                reader = PdfReader(src_stream)
                total = len(reader.pages)
                
                points = sorted(list(set([int(el.value) for el in document.querySelectorAll(".split-point")])))
                points.append(total)
                
                zip_stream = io.BytesIO()
                with zipfile.ZipFile(zip_stream, "w", compression=zipfile.ZIP_STORED) as zf:
                    start = 0
                    for i, end in enumerate(points):
                        # é€²æ—è¡¨ç¤º
                        p_fill.style.width = f"{(i/len(points))*100}%"
                        await asyncio.sleep(0.01)
                        
                        writer = PdfWriter()
                        # ãƒšãƒ¼ã‚¸ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆã“ã®æ–¹æ³•ãŒä¸€ç•ªãƒ¡ãƒ¢ãƒªæ¶ˆè²»ãŒå°‘ãªã„ï¼‰
                        for p_idx in range(start, end):
                            writer.add_page(reader.pages[p_idx])
                        
                        tmp_out = io.BytesIO()
                        writer.write(tmp_out)
                        zf.writestr(f"part_{i+1}.pdf", tmp_out.getvalue())
                        start = end
                
                # æœ€çµ‚å‡ºåŠ›
                blob = Blob.new([Uint8Array.new(zip_stream.getvalue())], type="application/zip")
                dl_link = document.getElementById("download_link")
                dl_link.href = URL.createObjectURL(blob)
                dl_link.download = f"split_{file_name}.zip"
                dl_link.style.display = "block"
                status.innerText = "âœ… å®Œäº†ã—ã¾ã—ãŸï¼"
                p_fill.style.width = "100%"
            except Exception as e:
                status.innerText = f"ã‚¨ãƒ©ãƒ¼: {str(e)}"
            finally:
                btn.disabled = False
    </script>
</body>
</html>
