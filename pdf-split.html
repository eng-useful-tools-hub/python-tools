<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>é«˜æ©Ÿèƒ½ PDFåˆ†å‰²ãƒ„ãƒ¼ãƒ« v1.09</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://bundle.run/jszip@3.10.1"></script>
    <link rel="stylesheet" href="https://pyscript.net/releases/2023.11.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2023.11.1/core.js"></script>

    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 700px; margin: auto; line-height: 1.6; color: #333; background-color: #f4f7f9; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px;}
        .version-tag { text-align: right; font-size: 0.8em; color: #999; margin-top: -10px; margin-bottom: 10px; }
        #drop_zone { border: 2px dashed #0969da; border-radius: 10px; padding: 40px; text-align: center; background: #fff; cursor: pointer; }
        #status { font-weight: bold; margin: 15px 0; text-align: center; color: #d93025; }
        button { background-color: #0969da; color: white; border: none; border-radius: 6px; cursor: pointer; width: 100%; padding: 15px; font-size: 16px; font-weight: bold; transition: 0.2s; }
        button:hover { background-color: #0550ae; }
        button:disabled { background-color: #ccc; }
        #download_link { display: none; text-align: center; background-color: #2ea44f; color: white; padding: 15px; text-decoration: none; border-radius: 6px; font-weight: bold; margin-top: 10px; }
        .progress-bar { width: 100%; background: #eee; height: 12px; border-radius: 6px; overflow: hidden; display: none; margin-top: 10px; }
        .progress-fill { width: 0%; background: #0969da; height: 100%; transition: width 0.2s; }
    </style>
</head>
<body>

    <h1>âœ‚ï¸ PDFåˆ†å‰²ãƒ„ãƒ¼ãƒ«</h1>
    <div class="version-tag">Ver 1.09 (å¤§å®¹é‡å¯¾å¿œãƒ»JSã‚¨ãƒ³ã‚¸ãƒ³æ­è¼‰ç‰ˆ)</div>

    <div class="card">
        <h3>1. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</h3>
        <p style="font-size: 0.85em; color: #666;">ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ã‚’æœ€å¤§åŒ–ã—ã¾ã—ãŸã€‚æ•°ç™¾MBä»¥ä¸Šã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚‚ãƒ–ãƒ©ã‚¦ã‚¶ã®é™ç•Œã¾ã§å‡¦ç†å¯èƒ½ã§ã™ã€‚</p>
        <div id="drop_zone">ğŸ“„ ã“ã“ã«PDFã‚’ãƒ‰ãƒ­ãƒƒãƒ— ã¾ãŸã¯ ã‚¯ãƒªãƒƒã‚¯</div>
        <input type="file" id="file_input" accept="application/pdf" style="display: none;">
        <div id="file_info" style="margin-top:15px; font-weight:bold; color: #0969da;"></div>
        <div id="status"></div>
        <div class="progress-bar" id="p_bar"><div class="progress-fill" id="p_fill"></div></div>
    </div>

    <div class="card" id="step2_area" style="display: none;">
        <h3>2. åˆ†å‰²è¨­å®š</h3>
        <p>åˆ†å‰²æ•°: <input type="number" id="num_splits" value="2" min="2" max="100" style="width:60px; padding:5px;"></p>
        <div id="split_points_container" style="margin: 15px 0; font-size: 0.9em; background: #f8f9fa; padding: 10px; border-radius: 8px;"></div>
        <button id="split_btn">åˆ†å‰²å‡¦ç†ã‚’é–‹å§‹ï¼ˆZIPä¿å­˜ï¼‰</button>
        <a id="download_link">â¬‡ï¸ ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜</a>
    </div>

    <script>
        // å¤§å®¹é‡å¯¾å¿œã®ãŸã‚ã€ãƒ¡ã‚¤ãƒ³å‡¦ç†ã‚’JavaScript(PDF-LIB)ã§è¨˜è¿°
        let currentPdfArrayBuffer = null;
        let fileName = "";

        const dropZone = document.getElementById('drop_zone');
        const fileInput = document.getElementById('file_input');
        const status = document.getElementById('status');
        const fileInfo = document.getElementById('file_info');
        const step2Area = document.getElementById('step2_area');
        const splitBtn = document.getElementById('split_btn');
        const pBar = document.getElementById('p_bar');
        const pFill = document.getElementById('p_fill');

        dropZone.onclick = () => fileInput.click();
        
        fileInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            fileName = file.name;
            status.innerText = "èª­ã¿è¾¼ã¿ä¸­...";
            
            try {
                currentPdfArrayBuffer = await file.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(currentPdfArrayBuffer, { ignoreEncryption: true });
                const totalPages = pdfDoc.getPageCount();
                
                fileInfo.innerText = `ğŸ“„ ${fileName} (${(file.size/1024/1024).toFixed(1)} MB / ${totalPages} ãƒšãƒ¼ã‚¸)`;
                status.innerText = "";
                step2Area.style.display = "block";
                updateSplitInputs(totalPages);
            } catch (err) {
                status.innerText = "ã‚¨ãƒ©ãƒ¼: PDFã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
                console.error(err);
            }
        };

        function updateSplitInputs(total) {
            const num = parseInt(document.getElementById('num_splits').value) || 2;
            const container = document.getElementById('split_points_container');
            const step = total / num;
            let html = "<strong>è‡ªå‹•è¨ˆç®—ã•ã‚ŒãŸåŒºåˆ‡ã‚Šä½ç½®:</strong>";
            for (let i = 1; i < num; i++) {
                let val = Math.floor(step * i);
                html += `<div>${i}ã¤ç›®ã®åŒºåˆ‡ã‚Š: <input type="number" class="split-point" value="${val}" min="1" max="${total-1}" style="width:50px;"> ãƒšãƒ¼ã‚¸ã®å¾Œ</div>`;
            }
            container.innerHTML = html;
        }

        document.getElementById('num_splits').onchange = () => {
            const file = fileInput.files[0];
            if (currentPdfArrayBuffer) {
                PDFLib.PDFDocument.load(currentPdfArrayBuffer).then(doc => updateSplitInputs(doc.getPageCount()));
            }
        };

        splitBtn.onclick = async () => {
            status.innerText = "åˆ†å‰²ãƒ»ZIPç”Ÿæˆä¸­...";
            status.style.color = "#0969da";
            splitBtn.disabled = true;
            pBar.style.display = "block";
            
            try {
                const srcDoc = await PDFLib.PDFDocument.load(currentPdfArrayBuffer);
                const total = srcDoc.getPageCount();
                const points = Array.from(document.querySelectorAll('.split-point')).map(el => parseInt(el.value));
                points.push(total);
                const sortedPoints = [...new Set(points)].sort((a, b) => a - b);
                
                const zip = new JSZip();
                let start = 0;
                
                for (let i = 0; i < sortedPoints.length; i++) {
                    const end = sortedPoints[i];
                    const newDoc = await PDFLib.PDFDocument.create();
                    
                    const indices = [];
                    for (let j = start; j < end; j++) indices.push(j);
                    
                    const copiedPages = await newDoc.copyPages(srcDoc, indices);
                    copiedPages.forEach(page => newDoc.addPage(page));
                    
                    const pdfBytes = await newDoc.save();
                    zip.file(`part_${i+1}_p${start+1}-${end}.pdf`, pdfBytes);
                    
                    start = end;
                    pFill.style.width = `${((i+1)/sortedPoints.length)*100}%`;
                }
                
                const zipBlob = await zip.generateAsync({ type: "blob" });
                const dlLink = document.getElementById('download_link');
                dlLink.href = URL.createObjectURL(zipBlob);
                dlLink.download = `split_${fileName}.zip`;
                dlLink.style.display = "block";
                status.innerText = "âœ… å®Œäº†ã—ã¾ã—ãŸï¼";
                status.style.color = "#2ea44f";
            } catch (err) {
                status.innerText = "å‡¦ç†ã‚¨ãƒ©ãƒ¼: ãƒ¡ãƒ¢ãƒªä¸è¶³ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚";
                console.error(err);
            } finally {
                splitBtn.disabled = false;
            }
        };

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã®å‡¦ç†
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.background = '#e8f0fe'; };
        dropZone.ondragleave = () => dropZone.style.background = '#fff';
        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.style.background = '#fff';
            fileInput.files = e.dataTransfer.files;
            fileInput.dispatchEvent(new Event('change'));
        };
    </script>
</body>
</html>
