<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>é«˜æ©Ÿèƒ½ PDFåˆ†å‰²ãƒ„ãƒ¼ãƒ«</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2023.11.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2023.11.1/core.js"></script>
    
    <py-config>
        packages = ["pypdf"]
    </py-config>

    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; padding: 20px; max-width: 700px; margin: auto; line-height: 1.6; color: #333; background-color: #f0f2f5; }
        h1 { color: #1a73e8; text-align: center; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;}
        
        /* æ³¨æ„æ›¸ãã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .limit-info { background-color: #fff4e5; border-left: 5px solid #ffa117; padding: 15px; margin-bottom: 20px; font-size: 0.9em; }
        .limit-info h4 { margin-top: 0; color: #855100; }
        
        #drop_zone { border: 2px dashed #1a73e8; border-radius: 10px; padding: 40px 20px; text-align: center; background-color: #f8f9fa; cursor: pointer; transition: 0.3s; }
        #drop_zone:hover { background-color: #e8f0fe; }
        
        .status-msg { font-weight: bold; text-align: center; margin: 15px 0; min-height: 1.5em; }
        .success { color: #28a745; }
        .error { color: #d93025; }
        
        button { background-color: #1a73e8; color: white; border: none; border-radius: 6px; cursor: pointer; width: 100%; padding: 15px; font-size: 16px; font-weight: bold; margin-top: 10px; }
        button:hover { background-color: #1557b0; }
        #download_link { display: none; text-align: center; background-color: #34a853; color: white; padding: 15px; text-decoration: none; border-radius: 6px; font-weight: bold; margin-top: 10px; }
        
        input[type="number"] { width: 60px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
    </style>
</head>
<body>

    <h1>âœ‚ï¸ PDFåˆ†å‰²ãƒ„ãƒ¼ãƒ«</h1>

    <div class="limit-info">
        <h4>ğŸ“¢ ã”åˆ©ç”¨ã®ç›®å®‰ã¨ãŠçŸ¥ã‚‰ã›</h4>
        <ul>
            <li><strong>å‡¦ç†ã®é™ç•Œ:</strong> ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ¡ãƒ¢ãƒªã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€<strong>50MBã€œ100MBç¨‹åº¦</strong>ã¾ã§ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¨å¥¨ã—ã¾ã™ã€‚</li>
            <li><strong>ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼:</strong> ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã•ã‚Œãšã€ã‚ãªãŸã®PCå†…ã ã‘ã§å‡¦ç†ã•ã‚Œã‚‹ãŸã‚å®‰å…¨ã§ã™ã€‚</li>
            <li><strong>å‹•ä½œç’°å¢ƒ:</strong> 100MBã‚’è¶…ãˆã‚‹å·¨å¤§ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚„ã€ãƒ¡ãƒ¢ãƒªã®å°‘ãªã„ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§ã¯å‹•ä½œãŒä¸å®‰å®šã«ãªã‚‹ï¼ˆãƒšãƒ¼ã‚¸ãŒæ¶ˆãˆã‚‹ï¼‰å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</li>
        </ul>
    </div>

    <div class="card">
        <h3>1. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€</h3>
        <div id="drop_zone">ğŸ“‚ ã“ã“ã«PDFã‚’ãƒ‰ãƒ­ãƒƒãƒ— ã¾ãŸã¯ ã‚¯ãƒªãƒƒã‚¯</div>
        <input type="file" id="file_input" accept="application/pdf" style="display: none;" py-change="on_file_loaded">
        <div id="file_info" style="margin-top:15px; font-weight:bold; color: #1a73e8;"></div>
        <div id="status" class="status-msg"></div>
    </div>

    <div class="card" id="step2_area" style="display: none;">
        <h3>2. åˆ†å‰²ã®è¨­å®š</h3>
        <p>
            åˆ†å‰²æ•°: <input type="number" id="num_splits" value="2" min="2" max="50" py-change="update_split_inputs"> åˆ†å‰²
        </p>
        <div id="split_points_container" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #eee;"></div>
        
        <p class="info-text" style="font-size: 0.85em; color: #666; margin-top: 15px;">
            â€»ã€Œå®Ÿè¡Œã€ã‚’æŠ¼ã™ã¨ZIPãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã€ã€Œãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ãƒ•ã‚©ãƒ«ãƒ€ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚
        </p>
        <button id="split_btn" py-click="execute_split">PDFã‚’åˆ†å‰²ã—ã¦ä¿å­˜</button>
        <a id="download_link">â¬‡ï¸ ç”Ÿæˆã•ã‚ŒãŸZIPã‚’ä¿å­˜ã™ã‚‹</a>
    </div>

    <script>
        const dropZone = document.getElementById('drop_zone');
        const fileInput = document.getElementById('file_input');
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = '#34a853'; });
        dropZone.addEventListener('dragleave', () => dropZone.style.borderColor = '#1a73e8');
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#1a73e8';
            if (e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files;
                fileInput.dispatchEvent(new Event('change', { bubbles: true }));
            }
        });
    </script>

    <script type="py">
        import asyncio, io, math, zipfile
        from js import document, Uint8Array, Blob, URL
        from pypdf import PdfReader, PdfWriter

        pdf_mem = None
        total_pages = 0
        file_name = ""

        async def on_file_loaded(event):
            global pdf_mem, total_pages, file_name
            status = document.getElementById("status")
            file_input = document.getElementById("file_input")
            if not file_input.files.length: return
            
            file = file_input.files.item(0)
            file_name = file.name
            status.className = "status-msg"
            status.innerText = "è§£æä¸­..."
            
            try:
                buf = await file.arrayBuffer()
                pdf_mem = io.BytesIO(bytes(Uint8Array.new(buf)))
                reader = PdfReader(pdf_mem)
                total_pages = len(reader.pages)
                
                size_mb = file.size / (1024 * 1024)
                document.getElementById("file_info").innerText = f"ğŸ“„ {file_name} ({size_mb:.1f} MB / {total_pages} ãƒšãƒ¼ã‚¸)"
                
                if size_mb > 100:
                    status.innerHTML = '<span class="error">âš ï¸ 100MBã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚å‹•ä½œãŒä¸å®‰å®šã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</span>'
                else:
                    status.innerText = ""
                
                document.getElementById("step2_area").style.display = "block"
                update_split_inputs(None)
            except Exception as e:
                status.innerHTML = '<span class="error">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒå£Šã‚Œã¦ã„ã‚‹ã‹ã€ãƒ¡ãƒ¢ãƒªä¸è¶³ã§ã™ã€‚</span>'

        def update_split_inputs(event):
            num = int(document.getElementById("num_splits").value or 2)
            container = document.getElementById("split_points_container")
            if num < 2 or num > total_pages:
                container.innerHTML = "åˆ†å‰²æ•°ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚"
                return
            html = "<strong>åŒºåˆ‡ã‚‹ãƒšãƒ¼ã‚¸ä½ç½®:</strong><br>"
            step = total_pages / num
            for i in range(1, num):
                val = math.floor(step * i)
                html += f"<div>{i}ã¤ç›®ã®åŒºåˆ‡ã‚Š: <input type='number' class='split-point' value='{val}' min='1' max='{total_pages-1}'> ãƒšãƒ¼ã‚¸ç›®ã®ç›´å¾Œ</div>"
            container.innerHTML = html

        async def execute_split(event):
            status = document.getElementById("status")
            status.innerText = "å‡¦ç†ä¸­... ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚"
            dl_link = document.getElementById("download_link")
            dl_link.style.display = "none"
            
            try:
                await asyncio.sleep(0.1)
                reader = PdfReader(pdf_mem)
                points = sorted(list(set([int(el.value) for el in document.querySelectorAll(".split-point")])))
                points.append(total_pages)
                
                zip_buf = io.BytesIO()
                with zipfile.ZipFile(zip_buf, "w") as zf:
                    start = 0
                    for i, end in enumerate(points):
                        if end <= start: continue
                        writer = PdfWriter()
                        for p in range(start, end):
                            writer.add_page(reader.pages[p])
                        out_pdf = io.BytesIO()
                        writer.write(out_pdf)
                        zf.writestr(f"part_{i+1}_p{start+1}-{end}.pdf", out_pdf.getvalue())
                        start = end
                
                blob = Blob.new([Uint8Array.new(zip_buf.getvalue())], type="application/zip")
                dl_link.href = URL.createObjectURL(blob)
                dl_link.download = f"split_{file_name}.zip"
                dl_link.style.display = "block"
                status.innerHTML = '<span class="success">âœ… åˆ†å‰²ãŒå®Œäº†ã—ã¾ã—ãŸï¼</span>'
            except Exception as e:
                status.innerHTML = '<span class="error">å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</span>'
    </script>
</body>
</html>
